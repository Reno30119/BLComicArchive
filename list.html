<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¼«ç•«æ›¸åº« - æŸ¥è©¢ç³»çµ±</title>
    <link rel="stylesheet" href="list-style.css" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2215%22 y=%2220%22 width=%2220%22 height=%2260%22 fill=%22%23e74c3c%22 rx=%222%22/><rect x=%2240%22 y=%2210%22 width=%2220%22 height=%2270%22 fill=%22%233498db%22 rx=%222%22/><rect x=%2265%22 y=%2225%22 width=%2220%22 height=%2255%22 fill=%22%23f1c40f%22 rx=%222%22/></svg>"
    />
  </head>
  <body>
    <nav class="top-nav">
      <a href="index.html" class="nav-item">â• æ–°å¢æ›¸ç±</a>
      <a href="list.html" class="nav-item active">ğŸ” æŸ¥è©¢æ›¸åº«</a>
    </nav>

    <div class="list-container">
      <header class="list-header">
        <div class="search-bar">
          <div
            style="
              position: relative;
              flex: 1;
              display: flex;
              align-items: center;
            "
          >
            <input
              type="text"
              id="searchInput"
              placeholder="æœå°‹æ›¸åã€ä½œè€…æˆ–æ¨™ç±¤..."
              style="width: 100%; padding-right: 30px"
            />
            <span
              id="clearSearch"
              style="
                position: absolute;
                right: 20px;
                cursor: pointer;
                color: #ccc;
                display: none;
              "
              >âœ–</span
            >
          </div>
          <button id="refreshBtn" class="refresh-btn" onclick="fetchData()">
            ğŸ”„ æ›´æ–°æ•¸æ“š
          </button>
        </div>
        <div class="sort-group">
          <div class="filter-item">
            <span class="filter-label">ğŸ› ï¸ æ’åº</span>
            <div class="btn-group">
              <button class="sort-btn" onclick="sortData('rating')">
                â­ åˆ†æ•¸
              </button>
              <button class="sort-btn" onclick="sortData('author')">
                ğŸ–‹ï¸ ä½œè€…
              </button>
              <button class="sort-btn" onclick="sortData('title')">
                ğŸ“œ æ›¸å
              </button>
              <button class="sort-btn" onclick="sortData('date')">
                ğŸ“… æ—¥æœŸ
              </button>
            </div>
          </div>

          <div class="filter-item">
            <span class="filter-label">ğŸ™ åˆ†ç´š</span>
            <div class="btn-group">
              <select
                id="levelFilter"
                class="filter-select"
                onchange="applyFilters()"
              >
                <option value="all">æ‰€æœ‰åˆ†ç´š</option>
                <option value="è‚‰å¤š">ğŸ¥© è‚‰å¤š</option>
                <option value="æ­£å¸¸">ğŸ› æ­£å¸¸</option>
                <option value="è‚‰å°‘">ğŸ¥— è‚‰å°‘</option>
                <option value="æ¸…æ°´">ğŸ’§ æ¸…æ°´</option>
              </select>
            </div>
          </div>

          <div class="filter-item">
            <span class="filter-label">ğŸ’ è©•åˆ†</span>
            <div class="btn-group">
              <select
                id="ratingFilter"
                class="filter-select"
                onchange="applyFilters()"
              >
                <option value="all">æ‰€æœ‰åˆ†æ•¸å€é–“</option>
                <option value="8">8 åˆ†ä»¥ä¸Š (æ¨è–¦)</option>
                <option value="6">6-7 åˆ† (ä¸€èˆ¬)</option>
                <option value="0">5 åˆ†ä»¥ä¸‹ (é¿é›·)</option>
              </select>
            </div>
          </div>

          <div class="filter-item reviewer-filter-item">
            <span class="filter-label">ğŸ¨ è©•è«–è€…</span>
            <div class="btn-group">
              <button class="filter-btn active" data-reviewer="all">
                å…¨éƒ¨
              </button>
              <button class="filter-btn" data-reviewer="Reno">Reno</button>
              <button class="filter-btn" data-reviewer="èŒ¶å£º">èŒ¶å£º</button>
            </div>
            <div
              class="reset-container"
              style="text-align: center; margin-top: 10px"
            >
              <button
                id="resetAllBtn"
                class="reset-btn"
                onclick="resetAllFilters()"
                style="
                  padding: 8px 18px;
                  background: #f1f3f5;
                  border: 1px solid #dee2e6;
                  border-radius: 8px;
                  cursor: pointer;
                  color: #666;
                  font-size: 0.9em;
                  transition: 0.2s;
                "
              >
                ğŸ§¹ é‡ç½®æ‰€æœ‰æ¢ä»¶
              </button>
            </div>
          </div>
        </div>
      </header>

      <div id="loading">è®€å–æ›¸åº«ä¸­...</div>
      <div class="book-grid" id="bookGrid"></div>
    </div>

    <div id="editModal" class="modal hidden">
      <div class="modal-content">
        <h3 id="modalTitle">ğŸ“ ç·¨è¼¯æ›¸ç±è³‡è¨Š</h3>
        <form id="editForm">
          <input type="hidden" id="editTimestamp" name="timestamp" />
          <input type="hidden" id="oldTitle" name="oldTitle" />
          <input type="hidden" name="action" value="update" />

          <div id="infoFieldsGroup">
            <label>ä¸­æ–‡æ›¸å</label>
            <input type="text" id="editTitle" name="title" required />

            <label>æ—¥æ–‡æ›¸å</label>
            <input type="text" id="editJpTitle" name="jpTitle" />

            <label>ä½œè€…</label>
            <input type="text" id="editAuthor" name="author" />
            <div style="display: flex; gap: 10px; margin-bottom: 15px">
              <div style="flex: 1">
                <label
                  style="display: block; font-size: 0.9em; margin-bottom: 5px"
                  >ğŸ‡¹ğŸ‡¼ å°ç£ç‹€æ…‹</label
                >
                <input
                  type="text"
                  id="editTwStatus"
                  name="twStatus"
                  placeholder="å°ç‰ˆé€²åº¦"
                />
              </div>
              <div style="flex: 1">
                <label
                  style="display: block; font-size: 0.9em; margin-bottom: 5px"
                  >ğŸ‡¯ğŸ‡µ æ—¥æœ¬ç‹€æ…‹</label
                >
                <input
                  type="text"
                  id="editJpStatus"
                  name="jpStatus"
                  placeholder="æ—¥ç‰ˆé€²åº¦"
                />
              </div>
            </div>
            <div style="display: flex; gap: 15px">
              <div style="flex: 1">
                <label>åˆ†ç´š</label>
                <select id="editLevel" name="level">
                  <option value="è‚‰å¤š">ğŸ¥© è‚‰å¤š</option>
                  <option value="æ­£å¸¸">ğŸ› æ­£å¸¸</option>
                  <option value="è‚‰å°‘">ğŸ¥— è‚‰å°‘</option>
                  <option value="æ¸…æ°´">ğŸ’§ æ¸…æ°´</option>
                </select>
              </div>
            </div>

            <label>æ¨™ç±¤ (ä»¥é€—è™Ÿ / ç©ºç™½éµåˆ†éš”)</label>
            <input type="text" id="editTags" name="tags" />

            <label>é›»å­æ›¸ç¶²å€</label>
            <input type="url" id="editEbookUrl" name="ebookUrl" />

            <label>ã¡ã‚‹ã¡ã‚‹ç¶²å€</label>
            <input type="url" id="editChilUrl" name="chilUrl" />
          </div>

          <div id="commentFieldsGroup">
            <label>è©•åˆ† (1-10)</label>
            <input
              type="number"
              id="editRating"
              name="rating"
              step="0.5"
              min="1"
              max="10"
            />

            <label>æˆ‘çš„è©•èª</label>
            <textarea
              id="editComment"
              name="comment"
              rows="6"
              placeholder="åˆ†äº«ä½ çš„è®€å¾Œæ„Ÿ..."
            ></textarea>
          </div>

          <div class="modal-btns">
            <button type="submit" class="save-btn">å„²å­˜ä¿®æ”¹</button>
            <button type="button" onclick="closeModal()" class="cancel-btn">
              å–æ¶ˆ
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="addCommentModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="addCommentModalTitle">âœï¸ æ–°å¢æ–°è©•è«–</h3>
        </div>
        <form id="addCommentForm">
          <input type="hidden" id="addCommentTargetTitle" name="title" />
          <input type="hidden" id="addCommentJpTitle" name="jpTitle" />
          <input type="hidden" id="addCommentAuthor" name="author" />
          <input type="hidden" id="addCommentLevel" name="level" />
          <input type="hidden" id="addCommentTags" name="tags" />
          <input type="hidden" id="addCommentEbookUrl" name="ebookUrl" />
          <input type="hidden" id="addCommentChilUrl" name="chilUrl" />
          <input type="hidden" id="addCommentCoverUrl" name="coverUrl" />
          <input type="hidden" id="addCommentTwStatus" name="twStatus" />
          <input type="hidden" id="addCommentJpStatus" name="jpStatus" />

          <div class="form-group">
            <label>è©•è«–è€…</label>
            <div class="reviewer-options">
              <button
                type="button"
                class="rev-select-btn"
                onclick="setAddReviewer('Reno', this)"
              >
                Reno
              </button>
              <button
                type="button"
                class="rev-select-btn"
                onclick="setAddReviewer('èŒ¶å£º', this)"
              >
                èŒ¶å£º
              </button>
            </div>
            <input
              type="hidden"
              id="addCommentReviewer"
              name="reviewer"
              required
            />
          </div>

          <div class="form-group">
            <label for="addCommentRating">è©•åˆ† (0.0 - 10.0)</label>
            <input
              type="number"
              id="addCommentRating"
              name="rating"
              min="0"
              max="10"
              step="0.5"
              value="5.0"
            />
          </div>

          <div class="form-group">
            <label for="addCommentContent">è©•èªå…§å®¹</label>
            <textarea
              id="addCommentContent"
              name="comment"
              rows="4"
              required
            ></textarea>
          </div>

          <div class="modal-footer">
            <button
              type="submit"
              class="save-review-btn"
              id="addCommentSaveBtn"
            >
              ç¢ºèªé€å‡º
            </button>
            <button
              type="button"
              class="cancel-btn"
              onclick="closeAddCommentModal()"
            >
              å–æ¶ˆ
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      /**
       * âš ï¸ é‡è¦æç¤ºï¼š
       * æ¯æ¬¡ä¿®æ”¹ GAS ç¨‹å¼ç¢¼å¾Œï¼Œè«‹é»æ“Šã€Œéƒ¨ç½²ã€->ã€Œç®¡ç†éƒ¨ç½²ã€->ã€Œç·¨è¼¯ã€->ã€Œç‰ˆæœ¬ï¼šæ–°ç‰ˆæœ¬ã€
       * é€™æ¨£æ‰èƒ½ç¢ºä¿ scriptURL ç¶­æŒä¸è®Šã€‚
       */
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwqnfCjBq_BYZSWAOU6TnVj2O6YvFF2jan4dY0smm3waf9xP-wOLmz2_4B_L3MND7PK9A/exec";

      let allBooks = [];

      window.addEventListener("DOMContentLoaded", fetchData);

      async function fetchData() {
        const loadingEl = document.getElementById("loading");
        try {
          if (loadingEl) {
            loadingEl.style.display = "block";
            loadingEl.innerHTML = "æ­£åœ¨åŒæ­¥æœ€æ–°æ›¸åº«...";
          }
          const response = await fetch(
            `${scriptURL}?action=read&t=${new Date().getTime()}`
          );
          if (!response.ok) throw new Error("ç¶²è·¯å›æ‡‰éŒ¯èª¤");

          allBooks = await response.json();

          if (allBooks && allBooks.length > 0) {
            // âš ï¸ é—œéµä¿®æ­£ï¼šåˆå§‹è®€å–æ”¹ç‚ºå‘¼å« applyFiltersï¼Œå®ƒæœƒè™•ç†åˆä½µé‚è¼¯ä¸¦å‘¼å« renderBooks
            applyFilters();
            if (loadingEl) loadingEl.style.display = "none";
          } else {
            if (loadingEl) loadingEl.innerHTML = "ğŸ“­ ç›®å‰æ›¸åº«ä¸­æ²’æœ‰è³‡æ–™ã€‚";
          }
        } catch (error) {
          console.error("è®€å–å¤±æ•—:", error);
          if (loadingEl)
            loadingEl.innerHTML =
              "âŒ è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª GAS éƒ¨ç½²ç‚ºã€Œæ‰€æœ‰äººã€ä¸”ç¶²å€æ­£ç¢º";
        }
      }
      function openEditModal(ts) {
        // æ‰¾å°‹å°æ‡‰æ™‚é–“æˆ³è¨˜çš„åŸå§‹è³‡æ–™
        const book = allBooks.find((b) => String(b.timestamp) === String(ts));
        if (!book) return;

        // å°‡æ‰€æœ‰æ¬„ä½å¡«å…¥è¡¨å–®ï¼Œé¿å…æ›´æ–°æ™‚æ¼æ‰è³‡æ–™
        document.getElementById("editTimestamp").value = book.timestamp || "";
        document.getElementById("editTitle").value = book.title || "";
        document.getElementById("editJpTitle").value = book.jpTitle || "";
        document.getElementById("editAuthor").value = book.author || "";
        document.getElementById("editLevel").value = book.level || "æ­£å¸¸";
        document.getElementById("editRating").value = book.rating || 5;
        document.getElementById("editTags").value = book.tags || "";
        document.getElementById("editEbookUrl").value = book.ebookUrl || "";
        document.getElementById("editChilUrl").value = book.chilUrl || "";
        document.getElementById("editComment").value = book.comment || "";

        document.getElementById("editModal").classList.remove("hidden");
      }

      let currentReviewer = "all";

      // 2. ç¶å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
          document
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("active"));
          this.classList.add("active");

          // æ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦é‡æ–°æ¸²æŸ“
          currentReviewer = this.getAttribute("data-reviewer");
          applyFilters();
        });
      });

      function renderBooks(data) {
        const grid = document.getElementById("bookGrid");
        if (!grid) return;
        grid.innerHTML = "";

        const validData = data.filter(
          (item) => item.title && String(item.title).trim() !== ""
        );

        data.forEach((book) => {
          const row = document.createElement("div");
          row.className = "book-list-item";
          const avgRating = parseFloat(book.avgRating || 0).toFixed(1);

          const coverUrl = book.coverUrl || "";
          const coverHTML =
            book.coverUrl && book.coverUrl !== ""
              ? `<img src="${book.coverUrl}" alt="å°é¢">`
              : `<div class="no-cover">
       <span>ç„¡å°é¢</span>
       <button onclick="reFetchCover('${book.title.replace(/'/g, "\\'")}', '${
                  book.ebookUrl || ""
                }', '${book.chilUrl || ""}')">ğŸ” æŠ“å–</button>
     </div>`;

          row.innerHTML = `
            <div class="item-main" style="display: flex; gap: 15px; align-items: flex-start;">
                <div class="book-cover-side">
                    ${coverHTML}
                </div>

                <div class="item-info" style="flex: 1;">
                    <div class="title-row" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span class="badge ${getLevelColor(book.level)}">${
            book.level
          }</span>
                        <h3 class="title" style="margin: 0; flex: 1;">${
                          book.title
                        }</h3>
                        <span class="avg-score ${getScoreColor(
                          avgRating
                        )}">${avgRating}</span>
                        
<button class="edit-book-btn" onclick="openBookInfoModal('${
            book.reviews[0].timestamp
          }')" title="ç·¨è¼¯æ›¸ç±åŸºæœ¬è³‡è¨Š" style="background:none; border:none; color:#3498db; cursor:pointer; font-size:16px; padding:0 5px;">âš™ï¸</button>
                    </div>

                    

              <p class="author" style="margin: 8px 0; margin-top:-2px">
                  ğŸ‘¤ <span class="author-link" onclick="quickSearch('${book.author.replace(
                    /'/g,
                    "\\'"
                  )}')">${book.author}</span> 
                  <span class="jp-title" style="color:#888;margin-left: 8px; font-size:0.85em;">${
                    book.jpTitle || ""
                  }</span>
                </p>
<div class="status-row" style="margin-top: 12px;display: flex; gap: 8px; margin-bottom: 4px; font-size: 0.82em;">
    <span style="background: #fff5f5; color: #c53030; padding: 2px 8px; border-radius: 4px; border: 1px solid #fed7d7;">
        ğŸ‡¹ğŸ‡¼ å°ï¼š${book.twStatus || "-"}
    </span>
    <span style="background: #eef2f7; color: #5a67d8; padding: 2px 8px; border-radius: 4px; border: 1px solid #dee2e6;">
        ğŸ‡¯ğŸ‡µ æ—¥ï¼š${book.jpStatus || "-"}
    </span>
</div>
              <div class="tags" style="margin-top: 8px; margin-bottom: 5px; display: flex; flex-wrap: wrap; gap: 2px;">
                  ${
                    book.tags
                      ? String(book.tags)
                          .split(",")
                          .map((t) => {
                            const tag = t.trim();
                            return `<span class="tag-badge" onclick="quickSearch('${tag.replace(
                              /'/g,
                              "\\'"
                            )}')">#${tag}</span>`;
                          })
                          .join("")
                      : ""
                  }
              </div>

                    <div class="item-links" style="margin-bottom: 10px;">
                        ${
                          book.ebookUrl
                            ? `<a href="${book.ebookUrl}" target="_blank" class="link-icon ebook">ğŸ“– Bookwalker</a>`
                            : ""
                        }
                        ${
                          book.chilUrl
                            ? `<a href="${book.chilUrl}" target="_blank" class="link-icon chil">ğŸ’ ã¡ã‚‹ã¡ã‚‹</a>`
                            : ""
                        }
                      <div class="add-review-action-area">
<button class="add-review-btn mobile-up-btn" onclick="openAddCommentModal('${
            book.reviews[0].timestamp
          }')">
  ğŸ“ æ–°å¢è©•è«–
</button>
                        </div>
                            
                    </div>


                    <div class="item-reviews" style="border-top: 1px solid #f0f0f0; padding-top: 10px;">
                        ${book.reviews
                          .map(
                            (r) => `
                            <div class="mini-review" style="position: relative; padding-right: 35px; margin-bottom: 5px; background: #fdfdfd; padding: 8px; border-radius: 6px;">
                                <span class="rev-name" style="font-weight:bold;">${
                                  r.reviewer
                                }</span><span style="color: #ddd;margin-left: 8px;">||</span>
                                <span class="rev-score ${getScoreColor(
                                  r.rating
                                )}"  style="margin-left:1px;">â­${
                              r.rating
                            }</span>
                                <span class="rev-comment" style="display:block; font-size:0.9em; color:#555;">${
                                  r.comment
                                }</span>
                                <button class="small-edit-btn" onclick="openCommentModal('${
                                  r.timestamp
                                }')" style="position:absolute; right:5px; top:8px; border:none; background:none; cursor:pointer; color:#ccc;">âœ</button>
                            </div>
                        `
                          )
                          .join("")}


                    </div>
                </div>
            </div>
        `;
          grid.appendChild(row);
        });
      }
      // 1. æŠ“å–å°é¢çš„è£œæ•‘åŠŸèƒ½
      async function reFetchCover(title, bwUrl, chilUrl) {
        // å„ªå…ˆé †åºï¼šBookWalker > Chil-Chil
        // æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰æ•ˆ (æ’é™¤ç©ºå­—ä¸²æˆ– "undefined" å­—ä¸²)
        let urlToFetch =
          bwUrl && bwUrl !== "" && bwUrl !== "undefined" ? bwUrl : null;

        if (!urlToFetch) {
          urlToFetch =
            chilUrl && chilUrl !== "" && chilUrl !== "undefined"
              ? chilUrl
              : null;
        }

        if (!urlToFetch) {
          alert("âŒ ç¼ºå°‘ BookWalker æˆ– Chil-Chil ç¶²å€ï¼Œè«‹å…ˆç·¨è¼¯æ›¸ç±è³‡è¨Šã€‚");
          return;
        }

        const btn = event.target;
        const coverContainer = btn.closest(".book-cover-side");
        const originalContent = coverContainer.innerHTML;
        coverContainer.innerHTML = "<span>âŒ› æŠ“å–ä¸­...</span>";

        try {
          const fetchUrl = `${scriptURL}?action=fetchCover&url=${encodeURIComponent(
            urlToFetch
          )}`;
          const res = await fetch(fetchUrl);
          const data = await res.json();

          if (data.coverUrl) {
            coverContainer.innerHTML = `<img src="${data.coverUrl}" alt="å°é¢">`;

            // åŒæ­¥æ›´æ–°å›è©¦ç®—è¡¨
            const formData = new FormData();
            formData.append("title", title);
            formData.append("coverUrl", data.coverUrl);
            formData.append("action", "updateCoverOnly");

            fetch(scriptURL, { method: "POST", body: formData });
            alert("âœ… å°é¢æŠ“å–æˆåŠŸï¼");
          } else {
            coverContainer.innerHTML = originalContent;
            alert("âŒ æŠ“å–å¤±æ•—ï¼š" + (data.error || "æ‰¾ä¸åˆ°åœ–ç‰‡"));
          }
        } catch (e) {
          coverContainer.innerHTML = originalContent;
          console.error("æŠ“å–éŒ¯èª¤:", e);
          alert("âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS ç‹€æ…‹ã€‚");
        }
      }

      // 1. é»æ“Šé½’è¼ªï¼šç·¨è¼¯åŸºæœ¬è³‡è¨Š
      function openBookInfoModal(ts) {
        console.log("ç•¶å‰é»æ“Šçš„æ™‚é–“æˆ³ TS:", ts); // é™¤éŒ¯é» 1

        const book = allBooks.find((b) => String(b.timestamp) === String(ts));

        console.log("æŠ“åˆ°çš„æ›¸æœ¬åŸå§‹è³‡æ–™:", book); // é™¤éŒ¯é» 2

        if (!book) {
          console.error("âŒ æ‰¾ä¸åˆ°è³‡æ–™ï¼è«‹æª¢æŸ¥ allBooks é™£åˆ—ä¸­æ˜¯å¦æœ‰é€™å€‹ TS");
          return;
        }

        // --- é—œéµï¼šæ¢å¾©é¡¯ç¤ºæ‰€æœ‰åŸºæœ¬æ¬„ä½ ---
        document.getElementById("infoFieldsGroup").style.display = "block";
        document.getElementById("commentFieldsGroup").style.display = "none";

        // æ¢å¾©æ›¸åèˆ‡å…¶æ¨™ç±¤çš„é¡¯ç¤º
        const titleInput = document.getElementById("editTitle");
        const titleLabel = titleInput.previousElementSibling;
        titleInput.style.display = "block";
        if (titleLabel && titleLabel.tagName === "LABEL")
          titleLabel.style.display = "block";

        document.getElementById("modalTitle").innerText = "âš™ï¸ ç·¨è¼¯æ›¸ç±åŸºæœ¬è³‡è¨Š";

        // å¡«å……è³‡æ–™
        // é—œéµå¡«å……ï¼šç¢ºä¿æ‰€æœ‰æ ¼å­åœ¨æäº¤æ™‚éƒ½æœ‰åŸæœ¬çš„å…§å®¹
        document.getElementById("oldTitle").value = book.title || "";
        document.getElementById("editTimestamp").value = book.timestamp || "";
        document.getElementById("editTitle").value = book.title || "";
        document.getElementById("editJpTitle").value = book.jpTitle || "";
        document.getElementById("editAuthor").value = book.author || "";
        document.getElementById("editLevel").value = book.level || "æ­£å¸¸";
        document.getElementById("editTags").value = book.tags || "";
        // ğŸ’¡ è£œä¸Šé€£è¼‰ç‹€æ…‹çš„å¡«å……
        document.getElementById("editTwStatus").value = book.twStatus || "";
        document.getElementById("editJpStatus").value = book.jpStatus || "";

        document.getElementById("editEbookUrl").value = book.ebookUrl || "";
        document.getElementById("editChilUrl").value = book.chilUrl || "";

        // å³ä½¿åœ¨é½’è¼ªæ¨¡å¼ï¼Œä¹Ÿè¦å¡«å…¥åˆ†æ•¸å’Œè©•èªï¼Œé˜²æ­¢ GAS å¯«å…¥ç©ºå€¼
        document.getElementById("editRating").value = book.rating || 5;
        document.getElementById("editComment").value = book.comment || "";

        document.getElementById("editModal").classList.remove("hidden");
      }

      function openCommentModal(ts) {
        console.log("ç•¶å‰é»æ“Šçš„æ™‚é–“æˆ³ TS:", ts); // é™¤éŒ¯é» 1

        const row = allBooks.find((b) => String(b.timestamp) === String(ts));

        console.log("æŠ“åˆ°çš„æ›¸æœ¬åŸå§‹è³‡æ–™:", row); // é™¤éŒ¯é» 2

        if (!row) {
          console.error("âŒ æ‰¾ä¸åˆ°è³‡æ–™ï¼è«‹æª¢æŸ¥ allBooks é™£åˆ—ä¸­æ˜¯å¦æœ‰é€™å€‹ TS");
          return;
        }

        // 1. åˆ‡æ› UI é¡¯ç¤ºï¼šéš±è—åŸºæœ¬è³‡è¨Šï¼Œé¡¯ç¤ºè©•èªå€
        document.getElementById("infoFieldsGroup").style.display = "none";
        document.getElementById("commentFieldsGroup").style.display = "block";

        // 2. éš±è—æ›¸åè¼¸å…¥æ¡†èˆ‡æ¨™ç±¤ (ç¶­æŒè©•èªæ¨¡å¼çš„ç°¡æ½”)
        const titleInput = document.getElementById("editTitle");
        const titleLabel = titleInput.previousElementSibling;
        titleInput.style.display = "none";
        if (titleLabel && titleLabel.tagName === "LABEL") {
          titleLabel.style.display = "none";
        }

        document.getElementById("modalTitle").innerText = "âœï¸ ç·¨è¼¯æˆ‘çš„è©•èª";

        // 3. å¡«å……æ‰€æœ‰è³‡æ–™ (é—œéµï¼šå³ä½¿éš±è—ä¹Ÿè¦å¡«ï¼ŒGAS æ‰æ‹¿å¾—åˆ°è³‡æ–™)
        document.getElementById("oldTitle").value = row.title || ""; // åŒæ­¥æ›´æ–°æ›¸åçš„é—œéµ
        document.getElementById("editTimestamp").value = row.timestamp || "";
        document.getElementById("editTitle").value = row.title || ""; // æ–°æ›¸åæš«æ™‚ç¶­æŒåŸç‹€
        document.getElementById("editJpTitle").value = row.jpTitle || "";
        document.getElementById("editAuthor").value = row.author || "";
        document.getElementById("editLevel").value = row.level || "æ­£å¸¸";
        document.getElementById("editTags").value = row.tags || "";
        // --- è£œä¸Šé€™å…©è¡Œï¼Œç¢ºä¿ç·¨è¼¯æ™‚ç‹€æ…‹ä¸æœƒä¸è¦‹ ---
        document.getElementById("editTwStatus").value = row.twStatus || ""; // å¡«å…¥å°ç£ç‹€æ…‹
        document.getElementById("editJpStatus").value = row.jpStatus || ""; // å¡«å…¥æ—¥æœ¬ç‹€æ…‹

        document.getElementById("editEbookUrl").value = row.ebookUrl || ""; // é˜²æ­¢ç¶²å€æ¶ˆå¤±
        document.getElementById("editChilUrl").value = row.chilUrl || ""; // é˜²æ­¢ç¶²å€æ¶ˆå¤±

        // å³ä½¿åœ¨é½’è¼ªæ¨¡å¼ï¼Œä¹Ÿè¦å¡«å…¥åˆ†æ•¸å’Œè©•èªï¼Œé˜²æ­¢ GAS å¯«å…¥ç©ºå€¼
        document.getElementById("editRating").value = row.rating || 5;
        document.getElementById("editComment").value = row.comment || "";

        document.getElementById("editModal").classList.remove("hidden");
        document.getElementById("editRating").dispatchEvent(new Event("input"));
      }

      // çµ±ä¸€è¨­å®š Modal é¡¯ç¤ºå“ªäº›æ¬„ä½
      function setupModal(mode, data) {
        document.getElementById("oldTitle").value = data.title || "";
        document.getElementById("editTimestamp").value = data.timestamp || "";
        document.getElementById("editTitle").value = data.title || "";
        const modalTitle = document.querySelector(".modal-content h3");
        const form = document.getElementById("editForm");

        // 1. å¡«å…¥å…±ç”¨è³‡æ–™
        document.getElementById("editTimestamp").value = data.timestamp || "";
        document.getElementById("editTitle").value = data.title || "";

        // 2. æ ¹æ“šæ¨¡å¼é¡¯ç¤º/éš±è—æ¬„ä½
        const infoFields = [
          "editJpTitle",
          "editAuthor",
          "editLevel",
          "editEbookUrl",
          "editChilUrl",
          "editTags",
        ];
        const commentFields = ["editRating", "editComment"];

        if (mode === "info") {
          modalTitle.innerText = "âš™ï¸ ç·¨è¼¯æ›¸ç±åŸºæœ¬è³‡è¨Š";
          toggleFields(infoFields, true);
          toggleFields(commentFields, false);
          // å¡«å……è³‡è¨Šé¡æ¬„ä½
          document.getElementById("editJpTitle").value = data.jpTitle || "";
          document.getElementById("editAuthor").value = data.author || "";
          document.getElementById("editLevel").value = data.level || "æ­£å¸¸";
          document.getElementById("editTags").value = data.tags || "";
          document.getElementById("editEbookUrl").value = data.ebookUrl || "";
          document.getElementById("editChilUrl").value = data.chilUrl || "";
        } else {
          modalTitle.innerText = "âœï¸ ç·¨è¼¯æˆ‘çš„è©•èª";
          toggleFields(infoFields, false);
          toggleFields(commentFields, true);
          // å¡«å……è©•èªé¡æ¬„ä½
          document.getElementById("editRating").value = data.rating || 5;
          document.getElementById("editComment").value = data.comment || "";
        }

        document.getElementById("editModal").classList.remove("hidden");
      }

      function toggleFields(fieldIds, isShow) {
        fieldIds.forEach((id) => {
          const input = document.getElementById(id);
          const label = input.previousElementSibling;
          // è™•ç†åŒ…è£¹å®¹å™¨ (å¦‚æœæ˜¯ flex ä½ˆå±€çš„ div)
          const container = input.closest('div[style*="flex"]') || input;

          if (label && label.tagName === "LABEL")
            label.style.display = isShow ? "block" : "none";
          input.style.display = isShow ? "block" : "none";
          if (container !== input)
            container.style.display = isShow ? "block" : "none";
        });
      }

      function closeModal() {
        document.getElementById("editModal").classList.add("hidden");
        document.getElementById("editForm").reset();
      }

      document.getElementById("editForm").onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        // æª¢æŸ¥çœ‹çœ‹é€™å…©å€‹å€¼æœ‰æ²’æœ‰å°å‡ºä¾†
        console.log("æ›´æ–°æ›¸åç‚º:", formData.get("title"));
        console.log("å°æ‡‰çš„æ™‚é–“æˆ³:", formData.get("timestamp"));

        const btn = e.target.querySelector(".save-btn");
        btn.innerText = "ğŸ’¾ æ›´æ–°ä¸­...";
        btn.disabled = true;

        try {
          await fetch(scriptURL, {
            method: "POST",
            body: formData,
            mode: "no-cors",
          });

          alert("âœ… è³‡æ–™å·²æäº¤æ›´æ–°ï¼");
          closeModal();
          // é‡æ–°æŠ“å–è³‡æ–™ä»¥çœ‹åˆ°æ›´æ–°å¾Œçš„æ›¸å
          setTimeout(fetchData, 1500);
        } catch (err) {
          alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + err.message);
        } finally {
          btn.innerText = "å„²å­˜ä¿®æ”¹";
          btn.disabled = false;
        }
      };

      // é¡è‰²é‚è¼¯ï¼šèˆ‡æ–°å¢æ™‚ä¸€è‡´
      function getScoreColor(val) {
        const s = parseFloat(val);
        if (s <= 5) return "text-green";
        if (s <= 7) return "text-blue";
        return "text-red";
      }

      function getLevelColor(level) {
        const mapping = {
          è‚‰å¤š: "red",
          æ­£å¸¸: "blue",
          è‚‰å°‘: "orange",
          æ¸…æ°´: "green",
        };
        return mapping[level] || "green";
      }

      // æœå°‹åŠŸèƒ½
      // âœ… æ›¿æ›æˆé€™è¡Œ
      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);

      // æ’åºåŠŸèƒ½
      function sortData(type) {
        if (type === "rating") {
          allBooks.sort((a, b) => b.rating - a.rating);
        } else {
          allBooks.sort((a, b) =>
            String(a[type]).localeCompare(String(b[type]), "zh-Hant")
          );
        }
        renderBooks(allBooks);
      }

      // é»æ“Šæ–‡å­—è‡ªå‹•å¡«å…¥æœå°‹æ¡†
      function quickSearch(text) {
        const searchInput = document.getElementById("searchInput");
        searchInput.value = text;
        // æ‰‹å‹•è§¸ç™¼ input äº‹ä»¶è®“æœå°‹é‚è¼¯åŸ·è¡Œ
        searchInput.dispatchEvent(new Event("input"));
        // æ²å‹•åˆ°é ‚éƒ¨æ–¹ä¾¿æŸ¥çœ‹
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      let currentSortType = "date"; // é è¨­ä¾æ—¥æœŸ

      // çµ±ä¸€æ’åºå…¥å£
      function sortData(type) {
        currentSortType = type;
        applyFilters();
      }

      // çµ±ä¸€æœå°‹ç›£è½
      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);

      // æ ¸å¿ƒéæ¿¾é‚è¼¯ï¼šå…ˆåˆä½µæ‰€æœ‰è©•èªï¼Œå†åŸ·è¡Œæœå°‹ã€åˆ†æ•¸èˆ‡è©•è«–è€…çš„ç¯©é¸
      function applyFilters() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const ratingThreshold = document.getElementById("ratingFilter").value;
        const levelThreshold = document.getElementById("levelFilter").value;

        // 1. åˆä½µé‚è¼¯ï¼šæŒ‰æ›¸ååˆ†çµ„ï¼Œæ”¶é›†æ‰€æœ‰è©•è«–
        const validData = allBooks.filter(
          (item) => item.title && String(item.title).trim() !== ""
        );

        const merged = validData.reduce((acc, curr) => {
          const bookTitle = String(curr.title).trim();
          if (!acc[bookTitle]) {
            acc[bookTitle] = {
              ...curr,
              title: bookTitle,
              reviews: [],
              tags: curr.tags || "",
            };
          }
          acc[bookTitle].reviews.push({
            reviewer: curr.reviewer || "åŒ¿å",
            rating: parseFloat(curr.rating) || 0,
            comment: curr.comment || "",
            timestamp: curr.timestamp,
          });
          return acc;
        }, {});

        // 2. è¨ˆç®—ç¶œåˆå¹³å‡åˆ†
        let processedBooks = Object.values(merged).map((book) => {
          const totalRating = book.reviews.reduce(
            (sum, r) => sum + r.rating,
            0
          );
          book.avgRating = totalRating / book.reviews.length;

          // B. ğŸ’¡ é—œéµæ–°å¢ï¼šè®“è©²æ›¸çš„è©•è«–ä¾ç…§è©•è«–è€…åå­—æ’åº (Reno, èŒ¶å£º...)
          book.reviews.sort((a, b) =>
            String(a.reviewer).localeCompare(String(b.reviewer), "zh-Hant")
          );

          return book;
        });

        // 3. åŸ·è¡Œéæ¿¾ (æœå°‹æ¡† + å¹³å‡åˆ†å€é–“ + è©•è«–è€…)
        let filtered = processedBooks.filter((book) => {
          // A. æœå°‹æ–‡å­—éæ¿¾
          const matchSearch =
            book.title.toLowerCase().includes(searchTerm) ||
            book.author.toLowerCase().includes(searchTerm) ||
            book.tags.toLowerCase().includes(searchTerm);

          // B. åˆ†æ•¸å€é–“éæ¿¾
          let matchRating = true;
          const score = book.avgRating;
          if (ratingThreshold === "8") matchRating = score >= 8;
          else if (ratingThreshold === "6")
            matchRating = score >= 6 && score < 8;
          else if (ratingThreshold === "0") matchRating = score < 6;

          // C. è©•è«–è€…ç¯©é¸é‚è¼¯
          const matchReviewer =
            currentReviewer === "all" ||
            book.reviews.some((r) => r.reviewer === currentReviewer);

          // D. åˆ†ç´šéæ¿¾é‚è¼¯
          const matchLevel =
            levelThreshold === "all" || book.level === levelThreshold;

          return matchSearch && matchRating && matchReviewer && matchLevel;
        });

        // 4. æ’åºé‚è¼¯ (ç¶­æŒåŸæ¨£)
        filtered.sort((a, b) => {
          if (currentSortType === "rating") return b.avgRating - a.avgRating;
          if (currentSortType === "author")
            return String(a.author).localeCompare(String(b.author), "zh-Hant");
          if (currentSortType === "title")
            return String(a.title).localeCompare(String(b.title), "zh-Hant");
          if (currentSortType === "date")
            return new Date(b.timestamp) - new Date(a.timestamp);
          return 0;
        });

        renderBooks(filtered);
      }

      const sInput = document.getElementById("searchInput");
      const cBtn = document.getElementById("clearSearch");

      sInput.addEventListener("input", () => {
        cBtn.style.display = sInput.value ? "block" : "inline";
        if (!sInput.value) cBtn.style.display = "none";
        applyFilters();
      });

      cBtn.addEventListener("click", () => {
        sInput.value = "";
        cBtn.style.display = "none";
        sInput.focus();
        applyFilters();
      });

      function resetAllFilters() {
        // 1. é‡ç½®æœå°‹æ¡†
        const searchInput = document.getElementById("searchInput");
        const clearBtn = document.getElementById("clearSearch");
        searchInput.value = "";
        if (clearBtn) clearBtn.style.display = "none";

        // 2. é‡ç½®ä¸‹æ‹‰é¸å–® (è©•åˆ†èˆ‡åˆ†ç´š)
        document.getElementById("ratingFilter").value = "all";
        if (document.getElementById("levelFilter")) {
          document.getElementById("levelFilter").value = "all";
        }

        // 3. é‡ç½®è©•è«–è€…æŒ‰éˆ•
        currentReviewer = "all";
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.getAttribute("data-reviewer") === "all") {
            btn.classList.add("active");
          }
        });

        // 4. é‡ç½®æ’åºé¡å‹ (é è¨­æ”¹å›æ—¥æœŸ)
        currentSortType = "date";

        // 5. åŸ·è¡Œéæ¿¾æ›´æ–°ç•«é¢
        applyFilters();

        // è¦–è¦ºåé¥‹ï¼šæ²å‹•å›é ‚éƒ¨
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // é–‹å•Ÿ Modal
      function openAddCommentModal(ts) {
        console.log("æ­£åœ¨æœå°‹ TS:", ts);

        const bookData = allBooks.find(
          (b) => String(b.timestamp) === String(ts)
        );

        console.log("æŠ“åˆ°çš„æ›¸æœ¬åŸå§‹è³‡æ–™:", bookData); // é™¤éŒ¯é» 2

        if (!bookData) {
          console.error("âŒ æ‰¾ä¸åˆ°è³‡æ–™ï¼è«‹æª¢æŸ¥ allBooks é™£åˆ—ä¸­æ˜¯å¦æœ‰é€™å€‹ TS");
          alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ›¸ç±è³‡è¨Š");
          return;
        }

        // å®‰å…¨å¡«å€¼å·¥å…·ï¼šå¦‚æœæ‰¾ä¸åˆ° IDï¼Œå°±ä¸æœƒå ±éŒ¯
        const safeSetVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) {
            el.value = val || "";
          } else {
            console.warn(`æ‰¾ä¸åˆ° ID: ${id}ï¼Œè«‹æª¢æŸ¥ HTML æ˜¯å¦æœ‰æ­¤éš±è—æ¬„ä½`);
          }
        };

        // å¡«å…¥è³‡æ–™
        safeSetVal("addCommentTargetTitle", bookData.title);
        safeSetVal("addCommentJpTitle", bookData.jpTitle);
        safeSetVal("addCommentAuthor", bookData.author);
        safeSetVal("addCommentLevel", bookData.level);
        safeSetVal("addCommentTags", bookData.tags);
        safeSetVal("addCommentEbookUrl", bookData.ebookUrl);
        safeSetVal("addCommentChilUrl", bookData.chilUrl);
        safeSetVal("addCommentCoverUrl", bookData.coverUrl);
        safeSetVal("addCommentTwStatus", bookData.twStatus);
        safeSetVal("addCommentJpStatus", bookData.jpStatus);

        // é¡¯ç¤º Modal
        document.getElementById(
          "addCommentModalTitle"
        ).innerText = `âœï¸ ç‚ºã€Š${bookData.title}ã€‹æ–°å¢æ–°è©•è«–`;
        document.getElementById("addCommentModal").classList.remove("hidden");
        document
          .getElementById("addCommentRating")
          .dispatchEvent(new Event("input"));
      }

      // é—œé–‰ Modal
      function closeAddCommentModal() {
        document.getElementById("addCommentModal").classList.add("hidden");
        document.getElementById("addCommentForm").reset();
        document
          .querySelectorAll(".rev-select-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById("addCommentReviewer").value = "";
      }

      // è©•è«–è€…é¸æ“‡åˆ‡æ›
      function setAddReviewer(name, btn) {
        document.getElementById("addCommentReviewer").value = name;
        document
          .querySelectorAll(".rev-select-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
      }

      // è™•ç†è¡¨å–®é€å‡º
      document.getElementById("addCommentForm").onsubmit = async function (e) {
        e.preventDefault();

        const reviewer = document.getElementById("addCommentReviewer").value;
        if (!reviewer) {
          alert("è«‹é¸æ“‡è©•è«–è€… (Reno æˆ– èŒ¶å£º)ï¼");
          return;
        }

        const btn = document.getElementById("addCommentSaveBtn");
        btn.disabled = true;
        btn.innerText = "å„²å­˜ä¸­...";

        // 1. å°è£è¡¨å–®æ•¸æ“š
        const formData = new FormData(this);
        // å¿…é ˆåŠ å…¥ action åƒæ•¸ï¼Œè®“ GAS å¾Œç«¯çš„ doPost çŸ¥é“é€™æ˜¯è¦åŸ·è¡Œ processForm
        formData.append("action", "processForm");

        try {
          // 2. æ”¹ç”¨ fetch é€å‡ºè³‡æ–™åˆ° scriptURL
          await fetch(scriptURL, {
            method: "POST",
            body: formData,
            mode: "no-cors", // é¿å…è·¨åŸŸé˜»æ“‹
          });

          // ç”±æ–¼ no-cors æ¨¡å¼ç„¡æ³•è®€å–å›æ‡‰ï¼Œæˆ‘å€‘ç›´æ¥å‡è¨­æˆåŠŸä¸¦çµ¦äºˆæç¤º
          alert("âœ… è©•è«–å·²æˆåŠŸå»ºç«‹ï¼(è³‡æ–™åŒæ­¥å¯èƒ½éœ€è¦å¹¾ç§’é˜)");
          closeAddCommentModal();

          // 3. å»¶é²ä¸€ä¸‹å†é‡æ–°è®€å–ï¼Œç¢ºä¿ Google è©¦ç®—è¡¨å·²å¯«å…¥å®Œç•¢
          setTimeout(fetchData, 1500);
        } catch (err) {
          console.error("å„²å­˜å¤±æ•—:", err);
          alert("âŒ å„²å­˜å¤±æ•—ï¼š" + err.message);
        } finally {
          btn.disabled = false;
          btn.innerText = "ç¢ºèªé€å‡º";
        }
      };

      document
        .getElementById("addCommentRating")
        .addEventListener("input", function () {
          const val = parseFloat(this.value);
          const ratingInput = this;

          // å…ˆæ¸…é™¤æ‰€æœ‰é¡è‰²é¡åˆ¥
          ratingInput.classList.remove(
            "rating-low",
            "rating-mid",
            "rating-high"
          );

          // æ ¹æ“šåˆ†æ•¸å¥—ç”¨é¡åˆ¥ (é‚è¼¯åŒ Index)
          if (val < 5) {
            ratingInput.classList.add("rating-low");
          } else if (val <= 7.5) {
            ratingInput.classList.add("rating-mid");
          } else {
            ratingInput.classList.add("rating-high");
          }
        });

      // ç‚ºã€Œç·¨è¼¯è©•è«–ã€çš„åˆ†æ•¸æ¬„ä½ç¶å®šè®Šè‰²é‚è¼¯
      document
        .getElementById("editRating")
        .addEventListener("input", function () {
          const val = parseFloat(this.value);
          const ratingInput = this;

          // æ¸…é™¤èˆŠé¡åˆ¥
          ratingInput.classList.remove(
            "rating-low",
            "rating-mid",
            "rating-high"
          );

          // å¥—ç”¨æ–°é¡åˆ¥
          if (val < 5) {
            ratingInput.classList.add("rating-low");
          } else if (val <= 7.5) {
            ratingInput.classList.add("rating-mid");
          } else {
            ratingInput.classList.add("rating-high");
          }
        });

      editTags.addEventListener("input", function (e) {
        let val = this.value;

        // å°‡ã€Œç©ºç™½ã€æˆ–ã€Œå…¨å½¢é “è™Ÿã€å³æ™‚æ›¿æ›ç‚ºåŠå½¢é€—è™Ÿ
        if (val.includes(" ") || val.includes("ã€")) {
          this.value = val.replace(/[ ã€]+/g, ",");
        }

        // é˜²æ­¢å‡ºç¾é€£çºŒé€—è™Ÿ
        this.value = this.value.replace(/,+/g, ",");
      });
    </script>
  </body>
</html>
