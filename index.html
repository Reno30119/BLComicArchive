<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¼«ç•«æ›¸åº« - å»ºç«‹æ›¸æœ¬</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2215%22 y=%2220%22 width=%2220%22 height=%2260%22 fill=%22%23e74c3c%22 rx=%222%22/><rect x=%2240%22 y=%2210%22 width=%2220%22 height=%2270%22 fill=%22%233498db%22 rx=%222%22/><rect x=%2265%22 y=%2225%22 width=%2220%22 height=%2255%22 fill=%22%23f1c40f%22 rx=%222%22/></svg>">
  </head>
  <body>
    <nav class="top-nav">
      <a href="index.html" class="nav-item active">â• æ–°å¢æ›¸ç±</a>
      <a href="list.html" class="nav-item">ğŸ” æŸ¥è©¢æ›¸åº«</a>
    </nav>

    <div class="container">
      <header class="form-header">
        <h2>ğŸ“š æ–°å¢æ¼«ç•«æ›¸ç±</h2>
        <p class="subtitle">åŒæ­¥è³‡è¨Šè‡³é›²ç«¯è³‡æ–™åº«</p>
      </header>

      <form id="bookForm">
        <div class="form-group">
          <label for="title">ä¸­æ–‡æ›¸å</label>
          <input type="text" id="title" name="title" required />
        </div>

        <div class="form-group">
          <label for="jpTitle">æ—¥æ–‡æ›¸å</label>
          <input type="text" id="jpTitle" name="jpTitle" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="author">ä½œè€…</label>
            <input type="text" id="author" name="author" required />
          </div>
          <div class="form-group">
            <label for="level">åˆ†ç´š</label>
            <select id="level" name="level">
              <option value="è‚‰å¤š">ğŸ¥© è‚‰å¤š</option>
              <option value="æ­£å¸¸">ğŸ› æ­£å¸¸</option>
              <option value="è‚‰å°‘">ğŸ¥— è‚‰å°‘</option>
              <option value="æ¸…æ°´">ğŸ’§ æ¸…æ°´</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="twStatus">ğŸ‡¹ğŸ‡¼ å°ç£é€£è¼‰ç‹€æ…‹</label>
            <input type="text" id="twStatus" name="twStatus" />
          </div>
          <div class="form-group">
            <label for="jpStatus">ğŸ‡¯ğŸ‡µ æ—¥æœ¬é€£è¼‰ç‹€æ…‹</label>
            <input type="text" id="jpStatus" name="jpStatus" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>è©•è«–è€…</label>
            <div class="reviewer-buttons">
              <button type="button" class="rev-btn" data-name="Reno">
                Reno
              </button>
              <button type="button" class="rev-btn" data-name="èŒ¶å£º">
                èŒ¶å£º
              </button>
            </div>
            <input
              type="hidden"
              id="reviewer"
              name="reviewer"
              value=""
              required
            />
          </div>
          <div class="form-group">
            <label for="rating">è©•åˆ† (1-10)</label>
            <div style="position: relative">
              <input
                type="number"
                id="rating"
                name="rating"
                min="1"
                max="10"
                step="0.5"
                value="5.0"
              />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="tags">æ¨™ç±¤</label>
          <input type="text" id="tags" name="tags" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="ebookUrl">é›»å­æ›¸ç¶²ç«™</label>
            <input type="url" id="ebookUrl" name="ebookUrl" />
          </div>
          <div class="form-group">
            <label for="chilUrl">ã¡ã‚‹ã¡ã‚‹</label>
            <input type="url" id="chilUrl" name="chilUrl" />
          </div>
        </div>

        <div class="form-group">
          <label for="comment">è©•èªå…§å®¹</label>
          <textarea id="comment" name="comment" rows="3"></textarea>
        </div>

        <button type="submit" id="submitBtn">ç¢ºèªé€å‡ºè³‡æ–™</button>
      </form>

      <div id="message" class="hidden"></div>
    </div>

    <script>
      // å–å¾—è©•åˆ†è¼¸å…¥æ¡†
      const ratingInput = document.getElementById("rating");

      // 1. å…ˆå®šç¾©æ‰€æœ‰éœ€è¦çš„è®Šæ•¸
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwqnfCjBq_BYZSWAOU6TnVj2O6YvFF2jan4dY0smm3waf9xP-wOLmz2_4B_L3MND7PK9A/exec";
      let allBooks = []; // ç”¨ä¾†å­˜æ”¾æŠ“å–å›ä¾†çš„è³‡æ–™

      // 2. å®šç¾©æŠ“å–è³‡æ–™çš„å‡½æ•¸
      async function fetchExistingData() {
        // é€™è£¡ç¾åœ¨å¯ä»¥æ­£ç¢ºè®€å–åˆ° scriptURL äº†
        const fetchURL = scriptURL + "?action=read";
        try {
          const response = await fetch(fetchURL);
          const data = await response.json();
          allBooks = data;
          console.log("è³‡æ–™åº«å·²åŒæ­¥ï¼Œå…±æœ‰ " + allBooks.length + " ç­†è³‡æ–™");
        } catch (error) {
          console.error("ç„¡æ³•è®€å–è³‡æ–™åº«:", error);
        }
      }

      // 3. åŸ·è¡ŒæŠ“å–å‹•ä½œ
      fetchExistingData();

      // å®šç¾©é¡è‰²åˆ‡æ›å‡½æ•¸
      function updateRatingColor(value) {
        const val = parseFloat(value);

        // å…ˆç§»é™¤æ‰€æœ‰é¡è‰²é¡åˆ¥
        ratingInput.classList.remove("rating-low", "rating-mid", "rating-high");

        if (val < 5) {
          ratingInput.classList.add("rating-low");
        } else if (val >= 5 && val <= 7) {
          ratingInput.classList.add("rating-mid");
        } else if (val > 7) {
          ratingInput.classList.add("rating-high");
        }
      }
      // åœ¨ index.html çš„ script å€å¡Šæ–°å¢
      document.getElementById("ebookUrl").addEventListener("blur", function () {
        const url = this.value.trim();
        if (url.includes("bookwalker.com.tw")) {
          const msg = document.getElementById("message");
          msg.innerHTML = "æ­£åœ¨æŠ“å– BookWalker å°é¢...";
          msg.className = "info";
          msg.classList.remove("hidden");

          fetch(`${scriptURL}?action=fetchCover&url=${encodeURIComponent(url)}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.coverUrl) {
                // å‡è¨­æ‚¨åœ¨è¡¨å–®ä¸­åŠ äº†ä¸€å€‹éš±è—æ¬„ä½ <input type="hidden" id="coverUrl" name="coverUrl">
                if (document.getElementById("coverUrl")) {
                  document.getElementById("coverUrl").value = data.coverUrl;
                }
                msg.innerHTML = "âœ… å°é¢æŠ“å–æˆåŠŸï¼";
                setTimeout(() => msg.classList.add("hidden"), 2000);
              }
            })
            .catch((err) => console.error("æŠ“å–å¤±æ•—", err));
        }
      });
      // ç›£è½è¼¸å…¥äº‹ä»¶ (æ‰“å­—æˆ–æŒ‰ä¸Šä¸‹éˆ•éƒ½æœƒè§¸ç™¼)
      ratingInput.addEventListener("input", (e) => {
        updateRatingColor(e.target.value);
      });

      const tagsInput = document.getElementById("tags");

      tagsInput.addEventListener("input", function (e) {
        let val = this.value;

        // 1. å¦‚æœè¼¸å…¥çš„æ˜¯ç©ºç™½ï¼Œç«‹å³å°‡å…¶æ›¿æ›ç‚ºé€—è™Ÿ
        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æŠŠã€Œç©ºç™½ã€æˆ–ã€Œé€£çºŒç©ºç™½ã€æ›¿æ›æˆä¸€å€‹é€—è™Ÿ
        if (val.includes(" ")) {
          this.value = val.replace(/\s+/g, ",");
        }

        // 2. é˜²æ­¢å‡ºç¾é€£çºŒé€—è™Ÿï¼ˆä¾‹å¦‚è¼¸å…¥äº†ç©ºç™½å¾Œåˆæ‰‹å‹•è¼¸å…¥é€—è™Ÿï¼‰
        this.value = this.value.replace(/,+/g, ",");
      });

      // è¡¨å–®é€å‡ºå‰çš„æœ€çµ‚æ¸…ç†
      document.getElementById("bookForm").onsubmit = function () {
        let rawTags = tagsInput.value;
        // å°‡æ‰€æœ‰é€—è™Ÿåˆ†å‰²ã€å»ç©ºç™½ã€éæ¿¾æ‰ç©ºçš„ï¼Œæœ€å¾Œå†ç”¨ã€Œé€—è™Ÿ+ç©ºç™½ã€çµ„åˆ
        tagsInput.value = rawTags
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t !== "")
          .join(", ");
      };
      // åˆå§‹åŒ–é¡è‰² (é é¢è¼‰å…¥æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡ï¼Œé è¨­ 5.0 æœƒæ˜¯è—è‰²)
      updateRatingColor(ratingInput.value);

      const form = document.getElementById("bookForm");
      const btn = document.getElementById("submitBtn");
      const msg = document.getElementById("message");

      const revButtons = document.querySelectorAll(".rev-btn");
      const reviewerInput = document.getElementById("reviewer");

      revButtons.forEach((button) => {
        button.addEventListener("click", () => {
          revButtons.forEach((b) => b.classList.remove("active"));
          button.classList.add("active");
          reviewerInput.value = button.getAttribute("data-name");
        });
      });

      // --- æ›¿æ›æˆé€™å€‹ç‰ˆæœ¬ï¼šæ–°å¢æ™‚è‡ªå‹•æŠ“å–å°é¢ ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!reviewerInput.value) {
          alert("è«‹é¸æ“‡ä¸€ä½è©•è«–è€…ï¼");
          return;
        }

        btn.disabled = true;
        btn.innerHTML = "æ­£åœ¨æŠ“å–å°é¢ä¸¦å¯«å…¥...";
        msg.className = "info show";
        msg.classList.remove("hidden");

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          // 1. è‡ªå‹•æŠ“å–å°é¢é‚è¼¯ï¼šå¦‚æœæœ‰ BookWalker ç¶²å€ä¸”ç›®å‰æ²’æœ‰å°é¢
          if (data.ebookUrl && data.ebookUrl.includes("bookwalker.com.tw")) {
            try {
              const coverRes = await fetch(
                `${scriptURL}?action=fetchCover&url=${encodeURIComponent(
                  data.ebookUrl
                )}`
              );
              const coverJson = await coverRes.json();
              if (coverJson.coverUrl) {
                formData.append("coverUrl", coverJson.coverUrl); // å°‡æŠ“åˆ°çš„å°é¢ç¶²å€å¡é€²å»
              }
            } catch (err) {
              console.error("å°é¢è‡ªå‹•æŠ“å–å¤±æ•—ï¼Œå°‡åƒ…ä¸Šå‚³è³‡æ–™", err);
            }
          }

          // 2. å‚³é€è³‡æ–™åˆ° GAS
          await fetch(scriptURL, {
            method: "POST",
            body: formData,
            mode: "no-cors", // ç”±æ–¼ Google Apps Script çš„ç‰¹æ€§ï¼Œå¿…é ˆä½¿ç”¨ no-cors
          });

          // 3. æˆåŠŸå¾Œçš„è™•ç†
          msg.innerHTML =
            "âœ… è³‡æ–™å·²æˆåŠŸåŒæ­¥ï¼" +
            (formData.get("coverUrl") ? " (å°é¢å·²è‡ªå‹•æŠ“å–)" : "");
          msg.className = "success show";
          form.reset();
          revButtons.forEach((b) => b.classList.remove("active"));
          reviewerInput.value = "";
          btn.disabled = false;
          btn.innerHTML = "ç¢ºèªé€å‡ºè³‡æ–™";
          window.scrollTo(0, 0);
        } catch (error) {
          console.error("å‚³é€å¤±æ•—:", error);
          msg.innerHTML = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
          msg.className = "error show";
          btn.disabled = false;
          btn.innerHTML = "å†è©¦ä¸€æ¬¡";
        }
      });

      // å–å¾—æ›¸åè¼¸å…¥æ¡†
      const titleInput = document.getElementById("title");

      titleInput.addEventListener("blur", function () {
        const inputTitle = this.value.trim();
        if (!inputTitle || allBooks.length === 0) return; // å¦‚æœé‚„æ²’æŠ“åˆ°è³‡æ–™å°±è·³é

        // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒæ›¸å
        const existingBook = allBooks.find(
          (b) => String(b.title).trim() === inputTitle
        );

        if (existingBook) {
          const confirmLoad = confirm(
            `ğŸ“¢ ç™¼ç¾é‡è¤‡ï¼\nã€Œ${inputTitle}ã€å·²ç¶“åœ¨æ›¸åº«ä¸­äº†ã€‚\næ˜¯å¦è¦è‡ªå‹•å¡«å…¥å·²æœ‰çš„è³‡æ–™ï¼Ÿ`
          );

          if (confirmLoad) {
            // è‡ªå‹•å¡«å…¥ (å°æ‡‰æ‚¨ index.html çš„ id)
            document.getElementById("jpTitle").value =
              existingBook.jpTitle || "";
            document.getElementById("author").value = existingBook.author || "";
            document.getElementById("level").value =
              existingBook.level || "æ­£å¸¸";
            document.getElementById("ebookUrl").value =
              existingBook.ebookUrl || "";
            document.getElementById("chilUrl").value =
              existingBook.chilUrl || "";
            document.getElementById("tags").value = existingBook.tags || "";

            alert("âœ… è³‡æ–™å·²å¸¶å…¥ï¼Œè«‹å¡«å¯«è©•èªå¾Œé€å‡ºã€‚");
          }
        }
      });
    </script>
  </body>
</html>


