<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¼«ç•«æ›¸åº« - å»ºç«‹æ›¸æœ¬</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2215%22 y=%2220%22 width=%2220%22 height=%2260%22 fill=%22%23e74c3c%22 rx=%222%22/><rect x=%2240%22 y=%2210%22 width=%2220%22 height=%2270%22 fill=%22%233498db%22 rx=%222%22/><rect x=%2265%22 y=%2225%22 width=%2220%22 height=%2255%22 fill=%22%23f1c40f%22 rx=%222%22/></svg>"
    />
  </head>
  <body>
    <nav class="top-nav">
      <a href="index.html" class="nav-item active">â• æ–°å¢æ›¸ç±</a>
      <a href="list.html" class="nav-item">ğŸ” æŸ¥è©¢æ›¸åº«</a>
    </nav>

    <div class="container">
      <header class="form-header">
        <h2>ğŸ“š æ–°å¢æ¼«ç•«æ›¸ç±</h2>
        <p class="subtitle">åŒæ­¥è³‡è¨Šè‡³é›²ç«¯è³‡æ–™åº«</p>
      </header>

      <form id="bookForm">
        <div class="form-group">
          <label for="title">ä¸­æ–‡æ›¸å</label>
          <input type="text" id="title" name="title" required />
        </div>

        <div class="form-group">
          <label for="jpTitle">æ—¥æ–‡æ›¸å</label>
          <input type="text" id="jpTitle" name="jpTitle" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="author">ä½œè€…</label>
            <input type="text" id="author" name="author" required />
          </div>
          <div class="form-group">
            <label for="level">åˆ†ç´š</label>
            <select id="level" name="level">
              <option value="è‚‰å¤š">ğŸ¥© è‚‰å¤š</option>
              <option value="æ­£å¸¸" selected>ğŸ› æ­£å¸¸</option>
              <option value="è‚‰å°‘">ğŸ¥— è‚‰å°‘</option>
              <option value="æ¸…æ°´">ğŸ’§ æ¸…æ°´</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="twStatus">ğŸ‡¹ğŸ‡¼ å°ç£é€£è¼‰ç‹€æ…‹</label>
            <input type="text" id="twStatus" name="twStatus" />
          </div>
          <div class="form-group">
            <label for="jpStatus">ğŸ‡¯ğŸ‡µ æ—¥æœ¬é€£è¼‰ç‹€æ…‹</label>
            <input type="text" id="jpStatus" name="jpStatus" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>è©•è«–è€…</label>
            <div class="reviewer-buttons">
              <button type="button" class="rev-btn" data-name="Reno">
                Reno
              </button>
              <button type="button" class="rev-btn" data-name="èŒ¶å£º">
                èŒ¶å£º
              </button>
            </div>
            <input
              type="hidden"
              id="reviewer"
              name="reviewer"
              value=""
              required
            />
          </div>
          <div class="form-group">
            <label for="rating">è©•åˆ† (1-10)</label>
            <div style="position: relative">
              <input
                type="number"
                id="rating"
                name="rating"
                min="1"
                max="10"
                step="0.5"
                value="5.0"
              />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="tags">æ¨™ç±¤</label>
          <input type="text" id="tags" name="tags" />
        </div>
        <input type="hidden" id="coverUrl" name="coverUrl" value="" />
        <div class="form-row">
          <div class="form-group">
            <label for="ebookUrl">é›»å­æ›¸ç¶²ç«™</label>
            <input type="url" id="ebookUrl" name="ebookUrl" />
          </div>
          <div class="form-group">
            <label for="chilUrl">ã¡ã‚‹ã¡ã‚‹</label>
            <input type="url" id="chilUrl" name="chilUrl" />
          </div>
        </div>

        <div class="form-group">
          <label for="comment">è©•èªå…§å®¹</label>
          <textarea id="comment" name="comment" rows="3"></textarea>
        </div>

        <div class="form-actions-row">
          <button type="submit" id="submitBtn">ç¢ºèªé€å‡ºè³‡æ–™</button>
          <button
            type="button"
            class="icon-clear-btn"
            onclick="clearFullForm()"
            title="æ¸…ç©ºè³‡æ–™"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </form>

      <div id="message" class="hidden"></div>
    </div>

    <script>
      // å–å¾—è©•åˆ†è¼¸å…¥æ¡†
      const ratingInput = document.getElementById("rating");

      // 1. å…ˆå®šç¾©æ‰€æœ‰éœ€è¦çš„è®Šæ•¸
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwqnfCjBq_BYZSWAOU6TnVj2O6YvFF2jan4dY0smm3waf9xP-wOLmz2_4B_L3MND7PK9A/exec";
      let allBooks = []; // ç”¨ä¾†å­˜æ”¾æŠ“å–å›ä¾†çš„è³‡æ–™

      // 2. å®šç¾©æŠ“å–è³‡æ–™çš„å‡½æ•¸
      async function fetchExistingData() {
        // é€™è£¡ç¾åœ¨å¯ä»¥æ­£ç¢ºè®€å–åˆ° scriptURL äº†
        const fetchURL = scriptURL + "?action=read";
        try {
          const response = await fetch(fetchURL);
          const data = await response.json();
          allBooks = data;
          console.log("è³‡æ–™åº«å·²åŒæ­¥ï¼Œå…±æœ‰ " + allBooks.length + " ç­†è³‡æ–™");
        } catch (error) {
          console.error("ç„¡æ³•è®€å–è³‡æ–™åº«:", error);
        }
      }

      // 3. åŸ·è¡ŒæŠ“å–å‹•ä½œ
      fetchExistingData();

      // å®šç¾©é¡è‰²åˆ‡æ›å‡½æ•¸
      function updateRatingColor(value) {
        const val = parseFloat(value);

        // å…ˆç§»é™¤æ‰€æœ‰é¡è‰²é¡åˆ¥
        ratingInput.classList.remove("rating-low", "rating-mid", "rating-high");

        if (val < 5) {
          ratingInput.classList.add("rating-low");
        } else if (val >= 5 && val <= 7) {
          ratingInput.classList.add("rating-mid");
        } else if (val > 7) {
          ratingInput.classList.add("rating-high");
        }
      }

      // 1. å®šç¾©é€šç”¨çš„è‡ªå‹•æŠ“å–å‡½å¼
      async function autoFetchCover() {
        const bwUrl = document.getElementById("ebookUrl").value.trim();
        const chilUrl = document.getElementById("chilUrl").value.trim();
        const msg = document.getElementById("message");
        const coverInput = document.getElementById("coverUrl"); // ç¢ºä¿ä¸Šé¢æœ‰åŠ éš±è—æ¬„ä½

        const targetUrl = bwUrl || chilUrl;
        if (!targetUrl) return;

        // å¦‚æœæ‰¾ä¸åˆ° coverUrl æ¬„ä½ï¼Œåœ¨æ§åˆ¶å°æé†’ä½†ä¸è¦å´©æ½°
        if (!coverInput) {
          console.warn("æ‰¾ä¸åˆ° id='coverUrl' çš„éš±è—æ¬„ä½ï¼Œå°é¢ç¶²å€å°‡ç„¡æ³•å­˜å…¥ã€‚");
        }

        try {
          const res = await fetch(
            `${scriptURL}?action=fetchCover&url=${encodeURIComponent(
              targetUrl
            )}`
          );
          const data = await res.json();

          if (data.coverUrl) {
            if (coverInput) coverInput.value = data.coverUrl;
            msg.innerHTML = "âœ… å°é¢è‡ªå‹•é æŠ“æˆåŠŸï¼";
            msg.className = "success show";
            msg.classList.remove("hidden");
            setTimeout(() => msg.classList.add("hidden"), 2000);
          }
        } catch (err) {
          console.error("æŠ“å–å¤±æ•—", err);
        }
      }

      // 2. åŒæ™‚ç¶å®šç›£è½å™¨çµ¦å…©å€‹è¼¸å…¥æ¡†
      // ä¸è«–å“ªä¸€å€‹å¡«å®Œé›¢é–‹æ¸¸æ¨™ï¼ˆblurï¼‰ï¼Œéƒ½æœƒè§¸ç™¼æŠ“å–
      ["change"].forEach((evt) => {
        document
          .getElementById("ebookUrl")
          .addEventListener(evt, autoFetchCover);
        document
          .getElementById("chilUrl")
          .addEventListener(evt, autoFetchCover);
      });
      // ç›£è½è¼¸å…¥äº‹ä»¶ (æ‰“å­—æˆ–æŒ‰ä¸Šä¸‹éˆ•éƒ½æœƒè§¸ç™¼)
      ratingInput.addEventListener("input", (e) => {
        updateRatingColor(e.target.value);
      });

      const tagsInput = document.getElementById("tags");

      tagsInput.addEventListener("input", function (e) {
        let val = this.value;

        // å°‡ã€Œç©ºç™½ã€æˆ–ã€Œå…¨å½¢é “è™Ÿã€å³æ™‚æ›¿æ›ç‚ºåŠå½¢é€—è™Ÿ
        if (val.includes(" ") || val.includes("ã€")) {
          this.value = val.replace(/[ ã€]+/g, ",");
        }

        // é˜²æ­¢å‡ºç¾é€£çºŒé€—è™Ÿ
        this.value = this.value.replace(/,+/g, ",");
      });

      // è¡¨å–®é€å‡ºå‰çš„æœ€çµ‚æ¸…ç†
      document.getElementById("bookForm").onsubmit = function () {
        let rawTags = tagsInput.value;
        // ä½¿ç”¨æ­£è¦è¡¨é”å¼ /[ ,ã€]+/ åŒæ™‚åŒ¹é…ï¼šåŠå½¢é€—è™Ÿã€ç©ºæ ¼ã€å…¨å½¢é “è™Ÿ
        tagsInput.value = rawTags
          .split(/[ ,ã€]+/) // é€™è£¡æœƒæŠŠ é€—è™Ÿã€ç©ºæ ¼ã€é “è™Ÿ éƒ½ç•¶ä½œåˆ†éš”ç¬¦è™Ÿ
          .map((t) => t.trim())
          .filter((t) => t !== "")
          .join(", "); // æœ€å¾Œçµ±ä¸€æ ¼å¼åŒ–ç‚ºã€Œé€—è™Ÿ+ç©ºç™½ã€
      };
      // åˆå§‹åŒ–é¡è‰² (é é¢è¼‰å…¥æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡ï¼Œé è¨­ 5.0 æœƒæ˜¯è—è‰²)
      updateRatingColor(ratingInput.value);

      const form = document.getElementById("bookForm");
      const btn = document.getElementById("submitBtn");
      const msg = document.getElementById("message");

      const revButtons = document.querySelectorAll(".rev-btn");
      const reviewerInput = document.getElementById("reviewer");

      revButtons.forEach((button) => {
        button.addEventListener("click", () => {
          revButtons.forEach((b) => b.classList.remove("active"));
          button.classList.add("active");
          reviewerInput.value = button.getAttribute("data-name");
        });
      });

      // --- æ›¿æ›æˆé€™å€‹ç‰ˆæœ¬ï¼šæ–°å¢æ™‚è‡ªå‹•æŠ“å–å°é¢ ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!reviewerInput.value) {
          alert("è«‹é¸æ“‡ä¸€ä½è©•è«–è€…ï¼");
          return;
        }

        btn.disabled = true;
        btn.innerHTML = "æ­£åœ¨æŠ“å–å°é¢ä¸¦å¯«å…¥...";
        msg.className = "info show";
        msg.classList.remove("hidden");

        tagsInput.value = tagsInput.value
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t !== "")
          .join(", ");

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          // 1. è‡ªå‹•æŠ“å–å°é¢é‚è¼¯ï¼šå„ªå…ˆç”¨ ebookUrl (BookWalker)ï¼Œæ²’æœ‰å°±ç”¨ chilUrl (ã¡ã‚‹ã¡ã‚‹)
          const targetUrl = data.ebookUrl || data.chilUrl;

          // å¦‚æœç›®å‰éš±è—æ¬„ä½é‚„æ²’æœ‰å°é¢ç¶²å€ï¼Œä¸”æœ‰ä»»ä½•ä¸€å€‹ç¶²å€å­˜åœ¨ï¼Œå°±åŸ·è¡ŒæŠ“å–
          if (!data.coverUrl && targetUrl) {
            try {
              const coverRes = await fetch(
                `${scriptURL}?action=fetchCover&url=${encodeURIComponent(
                  targetUrl
                )}`
              );
              const coverJson = await coverRes.json();

              if (coverJson.coverUrl) {
                // é‡è¦ï¼šå°‡æŠ“åˆ°çš„ç¶²å€ã€Œå¯«å…¥ã€è¦é€å‡ºçš„ formData ä¸­
                formData.set("coverUrl", coverJson.coverUrl);
              }
            } catch (err) {
              console.error("å°é¢è‡ªå‹•æŠ“å–å¤±æ•—ï¼Œå°‡åƒ…ä¸Šå‚³ç¾æœ‰è³‡æ–™", err);
            }
          }

          // 2. å‚³é€è³‡æ–™åˆ° GAS
          await fetch(scriptURL, {
            method: "POST",
            body: formData,
            mode: "no-cors", // ç”±æ–¼ Google Apps Script çš„ç‰¹æ€§ï¼Œå¿…é ˆä½¿ç”¨ no-cors
          });

          // 3. æˆåŠŸå¾Œçš„è™•ç†
          msg.innerHTML = "âœ… è³‡æ–™å·²æˆåŠŸåŒæ­¥ï¼";
          msg.className = "success show";
          form.reset();
          updateRatingColor(5.0); // è®“è©•åˆ†é¡è‰²å›æ­¸é è¨­
          revButtons.forEach((b) => b.classList.remove("active"));
          reviewerInput.value = "";
          btn.disabled = false;
          btn.innerHTML = "ç¢ºèªé€å‡ºè³‡æ–™";
          window.scrollTo(0, 0);
          setTimeout(() => {
            msg.classList.add("hidden");
          }, 3000);
        } catch (error) {
          console.error("å‚³é€å¤±æ•—:", error);
          msg.innerHTML = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
          msg.className = "error show";
          btn.disabled = false;
          btn.innerHTML = "å†è©¦ä¸€æ¬¡";
        }
      });

      // å–å¾—æ›¸åè¼¸å…¥æ¡†
      const titleInput = document.getElementById("title");

      ["change"].forEach((evt) => {
        titleInput.addEventListener(evt, function () {
          const inputTitle = this.value.trim();

          // å¦‚æœè³‡æ–™åº«é‚„æ²’åŒæ­¥å®Œï¼Œå…ˆé¡¯ç¤ºæç¤ºæˆ–ä¸åŸ·è¡Œ
          if (!inputTitle) return;
          if (allBooks.length === 0) {
            console.log("è³‡æ–™åº«åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...");
            return;
          }

          const existingBook = allBooks.find(
            (b) => String(b.title).trim() === inputTitle
          );

          if (existingBook) {
            // é¿å…é‡è¤‡è·³å‡º confirmï¼Œæª¢æŸ¥æ˜¯å¦å·²ç¶“å¡«å…¥éè³‡æ–™
            if (document.getElementById("author").value !== "") return;

            const confirmLoad = confirm(
              `ğŸ“¢ ç™¼ç¾é‡è¤‡ï¼\nã€Œ${inputTitle}ã€å·²åœ¨æ›¸åº«ä¸­ã€‚æ˜¯å¦å¡«å…¥è³‡æ–™ï¼Ÿ`
            );

            if (confirmLoad) {
              document.getElementById("jpTitle").value =
                existingBook.jpTitle || "";
              document.getElementById("author").value =
                existingBook.author || "";
              document.getElementById("level").value =
                existingBook.level || "æ­£å¸¸";
              document.getElementById("twStatus").value =
                existingBook.twStatus || ""; // è£œä¸Šé€£è¼‰ç‹€æ…‹
              document.getElementById("jpStatus").value =
                existingBook.jpStatus || ""; // è£œä¸Šé€£è¼‰ç‹€æ…‹
              document.getElementById("ebookUrl").value =
                existingBook.ebookUrl || "";
              document.getElementById("chilUrl").value =
                existingBook.chilUrl || "";
              document.getElementById("tags").value = existingBook.tags || "";

              if (
                existingBook.coverUrl &&
                document.getElementById("coverUrl")
              ) {
                document.getElementById("coverUrl").value =
                  existingBook.coverUrl;
              }
              alert("âœ… è³‡æ–™å·²æˆåŠŸå¸¶å…¥ã€‚");
            }
          }
        });
      });

      function clearFullForm() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰å¡«å¯«çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
          // ä¿®æ­£é€™è£¡ï¼šä½ çš„ form ID æ˜¯ bookForm
          const form = document.getElementById("bookForm");

          form.reset();

          // é¡å¤–é‡ç½®éš±è—æ¬„ä½èˆ‡æŒ‰éˆ•ç‹€æ…‹
          document.getElementById("coverUrl").value = "";
          document.getElementById("reviewer").value = "";

          // ç§»é™¤è©•è«–è€…æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
          document
            .querySelectorAll(".rev-btn")
            .forEach((b) => b.classList.remove("active"));

          form.reset();
          // å›å¾©é è¨­è©•åˆ†é¡è‰²
          updateRatingColor(5.0);

          console.log("è¡¨å–®å·²å®Œå…¨æ¸…ç©º");
        }
      }
    </script>
  </body>
</html>
