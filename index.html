<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¼«ç•«æ›¸åº« - å»ºç«‹æ›¸æœ¬</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2215%22 y=%2220%22 width=%2220%22 height=%2260%22 fill=%22%23e74c3c%22 rx=%222%22/><rect x=%2240%22 y=%2210%22 width=%2220%22 height=%2270%22 fill=%22%233498db%22 rx=%222%22/><rect x=%2265%22 y=%2225%22 width=%2220%22 height=%2255%22 fill=%22%23f1c40f%22 rx=%222%22/></svg>"
    />
  </head>
  <body>
    <nav class="top-nav">
      <a href="index.html" class="nav-item active">â• æ–°å¢æ›¸ç±</a>
      <a href="list.html" class="nav-item">ğŸ” æŸ¥è©¢æ›¸åº«</a>
      <a href="tags.html" class="nav-item">ğŸ·ï¸ æ¨™ç±¤ç®¡ç†</a>
    </nav>

    <div class="container">
      <header class="form-header">
        <h2>ğŸ“š æ–°å¢æ¼«ç•«æ›¸ç±</h2>
        <div class="db-status-bar">
          <div id="dbCountBadge" class="status-badge">â™»ï¸ æ›¸åº«é€£ç·šä¸­...</div>
          <div id="dbTimeBadge" class="status-badge">ğŸ•’ --:--</div>
        </div>
      </header>

      <form id="bookForm">
        <div class="form-group">
          <label for="title">ä¸­æ–‡æ›¸å</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            placeholder="è«‹è¼¸å…¥æ›¸å"
          />
          <div id="searchFeedback" class="search-feedback"></div>
        </div>

        <div class="form-group">
          <label for="jpTitle">æ—¥æ–‡æ›¸å</label>
          <input type="text" id="jpTitle" name="jpTitle" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="author">ä½œè€…</label>
            <input type="text" id="author" name="author" required />
          </div>
          <div class="form-group">
            <label for="level">åˆ†ç´š</label>
            <select id="level" name="level">
              <option value="è‚‰å¤š">ğŸ¥© è‚‰å¤š</option>
              <option value="æ­£å¸¸" selected>ğŸ› æ­£å¸¸</option>
              <option value="è‚‰å°‘">ğŸ¥— è‚‰å°‘</option>
              <option value="æ¸…æ°´">ğŸ’§ æ¸…æ°´</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="twStatus">ğŸ‡¹ğŸ‡¼ å°ç£é€£è¼‰ç‹€æ…‹</label>
            <input type="text" id="twStatus" name="twStatus" />
          </div>
          <div class="form-group">
            <label for="jpStatus">ğŸ‡¯ğŸ‡µ æ—¥æœ¬é€£è¼‰ç‹€æ…‹</label>
            <input type="text" id="jpStatus" name="jpStatus" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>è©•è«–è€…</label>
            <div class="reviewer-buttons">
              <button type="button" class="rev-btn" data-name="Reno">
                Reno
              </button>
              <button type="button" class="rev-btn" data-name="èŒ¶å£º">
                èŒ¶å£º
              </button>
            </div>
            <input
              type="hidden"
              id="reviewer"
              name="reviewer"
              value=""
              required
            />
          </div>
          <div class="form-group">
            <label for="rating">è©•åˆ† (1-10)</label>
            <div style="position: relative">
              <input
                type="number"
                id="rating"
                name="rating"
                min="1"
                max="10"
                step="0.5"
                value="5.0"
              />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="tags">æ¨™ç±¤ (ä»¥é€—è™Ÿ / ç©ºç™½éµåˆ†éš”)</label>
          <input
            type="text"
            id="tags"
            placeholder="è¼¸å…¥é—œéµå­—æˆ–é»é¸æ¨™ç±¤..."
            autocomplete="off"
          />

          <div class="tag-system-root" style="position: relative">
            <div id="customTagList" class="custom-tag-list"></div>

            <div class="tag-cloud-wrapper">
              <div id="tagCloud" class="tag-cloud"></div>
              <button
                type="button"
                id="toggleCloudBtn"
                class="toggle-cloud-btn"
              >
                å±•é–‹æ¨™ç±¤åˆ—è¡¨ â–¼
              </button>
            </div>
          </div>
        </div>

        <input type="hidden" id="coverUrl" name="coverUrl" value="" />
        <div class="form-row">
          <div class="form-group">
            <label for="ebookUrl">é›»å­æ›¸ç¶²ç«™</label>
            <input type="url" id="ebookUrl" name="ebookUrl" />
          </div>
          <div class="form-group">
            <label for="chilUrl">ã¡ã‚‹ã¡ã‚‹</label>
            <input type="url" id="chilUrl" name="chilUrl" />
          </div>
        </div>

        <div class="form-group">
          <label for="comment">è©•èªå…§å®¹</label>
          <textarea id="comment" name="comment" rows="3"></textarea>
        </div>

        <div class="form-actions-row">
          <button type="submit" id="submitBtn">ç¢ºèªé€å‡ºè³‡æ–™</button>
          <button
            type="button"
            class="icon-clear-btn"
            onclick="clearFullForm()"
            title="æ¸…ç©ºè³‡æ–™"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </form>

      <div id="message" class="hidden"></div>
    </div>

    <script>
      // å–å¾—è©•åˆ†è¼¸å…¥æ¡†
      const ratingInput = document.getElementById("rating");

      // 1. å…ˆå®šç¾©æ‰€æœ‰éœ€è¦çš„è®Šæ•¸
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwqnfCjBq_BYZSWAOU6TnVj2O6YvFF2jan4dY0smm3waf9xP-wOLmz2_4B_L3MND7PK9A/exec";
      let allBooks = []; // ç”¨ä¾†å­˜æ”¾æŠ“å–å›ä¾†çš„è³‡æ–™

      // çµ±ä¸€çš„åŒæ­¥å‡½å¼ï¼šè² è²¬æŠ“è³‡æ–™ã€æ›´æ–°è¨˜æ†¶é«” (allBooks)ã€æ›´æ–°ç¾åŒ–ç‹€æ…‹æ¬„
      async function fetchAndRefreshStatus() {
        const dbCountBadge = document.getElementById("dbCountBadge");
        const dbTimeBadge = document.getElementById("dbTimeBadge");

        try {
          // 1. æŠ“å–è³‡æ–™åº«
          const response = await fetch(scriptURL + "?action=read");
          allBooks = await response.json();

          // 2. è¨ˆç®—ã€Œä¸é‡è¤‡æ›¸ç±ã€æ•¸é‡ (ä½¿ç”¨ä½ å¯«å¥½çš„ç•°é«”å­—æ¨™æº–åŒ–é‚è¼¯)
          const uniqueTitles = new Set(
            allBooks.map((book) => normalizeText(String(book.title || ""))),
          );

          // 3. å–å¾—ç›®å‰æ™‚é–“
          const now = new Date();
          const timeStr = `${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;

          // 4. æ›´æ–°ç•«é¢ä¸Šçš„ç¾åŒ–æ¨™ç±¤
          if (dbCountBadge) {
            dbCountBadge.innerHTML = `ğŸ“– æ›¸ç±ï¼š${uniqueTitles.size} æœ¬ (å…± ${allBooks.length} ç­†è©•è«–)`;
          }
          if (dbTimeBadge) {
            dbTimeBadge.innerHTML = `ğŸ•’ æ›´æ–°ï¼š${timeStr}`;
          }

          console.log(`åŒæ­¥å®Œæˆï¼šç›®å‰æœ‰ ${uniqueTitles.size} æœ¬æ¼«ç•«ã€‚`);
        } catch (error) {
          if (dbCountBadge) dbCountBadge.innerHTML = "âŒ é€£ç·šå¤±æ•—";
          console.error("è³‡æ–™è®€å–å¤±æ•—:", error);
        }
      }

      fetchAndRefreshStatus();

      // å®šç¾©é¡è‰²åˆ‡æ›å‡½æ•¸
      function updateRatingColor(value) {
        const val = parseFloat(value);

        // å…ˆç§»é™¤æ‰€æœ‰é¡è‰²é¡åˆ¥
        ratingInput.classList.remove("rating-low", "rating-mid", "rating-high");

        if (val < 5) {
          ratingInput.classList.add("rating-low");
        } else if (val >= 5 && val <= 7) {
          ratingInput.classList.add("rating-mid");
        } else if (val > 7) {
          ratingInput.classList.add("rating-high");
        }
      }

      // 1. å®šç¾©é€šç”¨çš„è‡ªå‹•æŠ“å–å‡½å¼
      async function autoFetchCover() {
        const bwUrl = document.getElementById("ebookUrl").value.trim();
        const chilUrl = document.getElementById("chilUrl").value.trim();
        const msg = document.getElementById("message");
        const coverInput = document.getElementById("coverUrl"); // ç¢ºä¿ä¸Šé¢æœ‰åŠ éš±è—æ¬„ä½

        const targetUrl = bwUrl || chilUrl;
        if (!targetUrl) return;

        // å¦‚æœæ‰¾ä¸åˆ° coverUrl æ¬„ä½ï¼Œåœ¨æ§åˆ¶å°æé†’ä½†ä¸è¦å´©æ½°
        if (!coverInput) {
          console.warn("æ‰¾ä¸åˆ° id='coverUrl' çš„éš±è—æ¬„ä½ï¼Œå°é¢ç¶²å€å°‡ç„¡æ³•å­˜å…¥ã€‚");
        }

        try {
          const res = await fetch(
            `${scriptURL}?action=fetchCover&url=${encodeURIComponent(
              targetUrl,
            )}`,
          );
          const data = await res.json();

          if (data.coverUrl) {
            if (coverInput) coverInput.value = data.coverUrl;
            msg.innerHTML = "âœ… å°é¢è‡ªå‹•é æŠ“æˆåŠŸï¼";
            msg.className = "success show";
            msg.classList.remove("hidden");
            setTimeout(() => msg.classList.add("hidden"), 2000);
          }
        } catch (err) {
          console.error("æŠ“å–å¤±æ•—", err);
        }
      }

      // 2. åŒæ™‚ç¶å®šç›£è½å™¨çµ¦å…©å€‹è¼¸å…¥æ¡†
      // ä¸è«–å“ªä¸€å€‹å¡«å®Œé›¢é–‹æ¸¸æ¨™ï¼ˆblurï¼‰ï¼Œéƒ½æœƒè§¸ç™¼æŠ“å–
      ["change"].forEach((evt) => {
        document
          .getElementById("ebookUrl")
          .addEventListener(evt, autoFetchCover);
        document
          .getElementById("chilUrl")
          .addEventListener(evt, autoFetchCover);
      });
      // ç›£è½è¼¸å…¥äº‹ä»¶ (æ‰“å­—æˆ–æŒ‰ä¸Šä¸‹éˆ•éƒ½æœƒè§¸ç™¼)
      ratingInput.addEventListener("input", (e) => {
        updateRatingColor(e.target.value);
      });

      const tagsInput = document.getElementById("tags");

      tagsInput.addEventListener("input", function (e) {
        let val = this.value;

        // å°‡ã€Œç©ºç™½ã€æˆ–ã€Œå…¨å½¢é “è™Ÿã€å³æ™‚æ›¿æ›ç‚ºåŠå½¢é€—è™Ÿ
        if (val.includes(" ") || val.includes("ã€")) {
          this.value = val.replace(/[ ã€]+/g, ",");
        }

        // é˜²æ­¢å‡ºç¾é€£çºŒé€—è™Ÿ
        this.value = this.value.replace(/,+/g, ",");
      });

      // è¡¨å–®é€å‡ºå‰çš„æœ€çµ‚æ¸…ç†
      document.getElementById("bookForm").onsubmit = function () {
        let rawTags = tagsInput.value;
        // ä½¿ç”¨æ­£è¦è¡¨é”å¼ /[ ,ã€]+/ åŒæ™‚åŒ¹é…ï¼šåŠå½¢é€—è™Ÿã€ç©ºæ ¼ã€å…¨å½¢é “è™Ÿ
        tagsInput.value = rawTags
          .split(/[ ,ã€]+/) // é€™è£¡æœƒæŠŠ é€—è™Ÿã€ç©ºæ ¼ã€é “è™Ÿ éƒ½ç•¶ä½œåˆ†éš”ç¬¦è™Ÿ
          .map((t) => t.trim())
          .filter((t) => t !== "")
          .join(", "); // æœ€å¾Œçµ±ä¸€æ ¼å¼åŒ–ç‚ºã€Œé€—è™Ÿ+ç©ºç™½ã€
      };
      // åˆå§‹åŒ–é¡è‰² (é é¢è¼‰å…¥æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡ï¼Œé è¨­ 5.0 æœƒæ˜¯è—è‰²)
      updateRatingColor(ratingInput.value);

      const form = document.getElementById("bookForm");
      const btn = document.getElementById("submitBtn");
      const msg = document.getElementById("message");

      const revButtons = document.querySelectorAll(".rev-btn");
      const reviewerInput = document.getElementById("reviewer");

      revButtons.forEach((button) => {
        button.addEventListener("click", () => {
          revButtons.forEach((b) => b.classList.remove("active"));
          button.classList.add("active");
          reviewerInput.value = button.getAttribute("data-name");
        });
      });

      // --- æ›¿æ›æˆé€™å€‹ç‰ˆæœ¬ï¼šæ–°å¢æ™‚è‡ªå‹•æŠ“å–å°é¢ ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!reviewerInput.value) {
          alert("è«‹é¸æ“‡ä¸€ä½è©•è«–è€…ï¼");
          return;
        }

        btn.disabled = true;
        btn.innerHTML = "æ­£åœ¨æŠ“å–å°é¢ä¸¦å¯«å…¥...";
        msg.className = "info show";
        msg.classList.remove("hidden");

        tagsInput.value = tagsInput.value
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t !== "")
          .join(", ");

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          // 1. è‡ªå‹•æŠ“å–å°é¢é‚è¼¯ï¼šå„ªå…ˆç”¨ ebookUrl (BookWalker)ï¼Œæ²’æœ‰å°±ç”¨ chilUrl (ã¡ã‚‹ã¡ã‚‹)
          const targetUrl = data.ebookUrl || data.chilUrl;

          // å¦‚æœç›®å‰éš±è—æ¬„ä½é‚„æ²’æœ‰å°é¢ç¶²å€ï¼Œä¸”æœ‰ä»»ä½•ä¸€å€‹ç¶²å€å­˜åœ¨ï¼Œå°±åŸ·è¡ŒæŠ“å–
          if (!data.coverUrl && targetUrl) {
            try {
              const coverRes = await fetch(
                `${scriptURL}?action=fetchCover&url=${encodeURIComponent(
                  targetUrl,
                )}`,
              );
              const coverJson = await coverRes.json();

              if (coverJson.coverUrl) {
                // é‡è¦ï¼šå°‡æŠ“åˆ°çš„ç¶²å€ã€Œå¯«å…¥ã€è¦é€å‡ºçš„ formData ä¸­
                formData.set("coverUrl", coverJson.coverUrl);
              }
            } catch (err) {
              console.error("å°é¢è‡ªå‹•æŠ“å–å¤±æ•—ï¼Œå°‡åƒ…ä¸Šå‚³ç¾æœ‰è³‡æ–™", err);
            }
          }

          // 2. å‚³é€è³‡æ–™åˆ° GAS
          await fetch(scriptURL, {
            method: "POST",
            body: formData,
            mode: "no-cors", // ç”±æ–¼ Google Apps Script çš„ç‰¹æ€§ï¼Œå¿…é ˆä½¿ç”¨ no-cors
          });

          // --- åœ¨ form submit çš„æˆåŠŸè™•ç†å€æ®µ ---
          // 3. æˆåŠŸå¾Œçš„è™•ç†
          msg.innerHTML = "âœ… è³‡æ–™å·²æˆåŠŸåŒæ­¥ï¼";

          // ä¿®æ­£ï¼šç¢ºä¿ç§»é™¤æ‰€æœ‰å¯èƒ½é˜»æ“‹é¡¯ç¤ºçš„é¡åˆ¥
          msg.classList.remove("hidden");
          msg.style.display = "block"; // å¼·åˆ¶è®“å…ƒç´ ä½”æ“šç©ºé–“

          // ç¢ºä¿å¥—ç”¨æ­£ç¢ºçš„æ¨£å¼
          msg.className = "success show";

          form.reset();
          fetchAndRefreshStatus(); // æ›´æ–° ğŸ“– ç‹€æ…‹æ¬„
          resetSearchFeedback(); // æ¸…é™¤ã€Œå·²æœ‰æ­¤æ›¸ã€æç¤º
          updateRatingColor(5.0);
          revButtons.forEach((b) => b.classList.remove("active"));
          reviewerInput.value = "";
          btn.disabled = false;
          btn.innerHTML = "ç¢ºèªé€å‡ºè³‡æ–™";

          window.scrollTo({ top: 0, behavior: "smooth" }); // æ²å›é ‚éƒ¨çœ‹æç¤º

          // 3ç§’å¾Œè‡ªå‹•éš±è—
          setTimeout(() => {
            msg.classList.remove("show");
            msg.classList.add("hidden");
            msg.style.display = "none"; // å¾¹åº•éš±è—é¿å…ä½”ä½
          }, 3000);
        } catch (error) {
          console.error("å‚³é€å¤±æ•—:", error);
          msg.innerHTML = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
          msg.className = "error show";
          btn.disabled = false;
          btn.innerHTML = "å†è©¦ä¸€æ¬¡";
        }
      });

      // 1. ç¢ºä¿ç•°é«”å­—å°ç…§è¡¨å­˜åœ¨
      const variantMap = {
        ç§˜: "ç¥•",
        å°: "è‡º",
        é‡Œ: "è£¡",
        æœ: "è’",
        å‘ª: "å’’",
        è¿´: "å›",
        çŒ«: "è²“",
        å³°: "å³¯",
        å¶‹: "å³¶",
      };

      // 2. æ¨™æº–åŒ–æ–‡å­—å‡½å¼
      function normalizeText(str) {
        if (!str) return "";
        let normalized = str.trim().toLowerCase();
        for (let key in variantMap) {
          normalized = normalized.split(key).join(variantMap[key]);
        }
        return normalized;
      }

      // ç›£è½æ›¸åè¼¸å…¥
      const titleInput = document.getElementById("title");
      const feedback = document.getElementById("searchFeedback");
      let lastAlertedTitle = ""; // é¿å…é‡å°åŒä¸€å€‹æ›¸åé‡è¤‡è·³å‡º confirm

      let searchTimeout; // 1. ç”¨ä¾†å­˜æ”¾è¨ˆæ™‚å™¨çš„è®Šæ•¸

      titleInput.addEventListener("input", function () {
        const inputVal = this.value.trim();

        // 2. æ¯æ¬¡è¼¸å…¥å°±ç«‹åˆ»æ¸…é™¤ã€Œä¸Šä¸€æ¬¡ã€æº–å‚™è¦å½ˆå‡ºçš„è¦–çª—
        clearTimeout(searchTimeout);

        if (!inputVal) {
          feedback.innerHTML = "";
          feedback.className = "search-feedback";
          lastAlertedTitle = "";
          return;
        }

        // 3. é¡¯ç¤ºæœå°‹ä¸­
        feedback.innerHTML = "ğŸ” æ­£åœ¨æœå°‹æ›¸åº«...";
        feedback.className = "search-feedback active status-searching";

        const normalizedInput = normalizeText(inputVal);
        const existingBook = allBooks.find(
          (b) => normalizeText(String(b.title)) === normalizedInput,
        );

        if (existingBook) {
          feedback.innerHTML = "âš ï¸ æ›¸åº«å…§å·²æœ‰æ­¤æ›¸";
          feedback.className = "search-feedback active status-found";

          // 4. ä¿ç•™ä½ è¦æ±‚çš„é‚è¼¯ï¼Œä½†åŒ…åœ¨å®šæ™‚å™¨å…§ä¸¦ç¢ºä¿åªæœƒåŸ·è¡Œæœ€å¾Œä¸€æ¬¡è¼¸å…¥çš„åˆ¤å®š
          if (lastAlertedTitle !== normalizedInput) {
            searchTimeout = setTimeout(() => {
              if (
                confirm(
                  `ğŸ“¢ ç™¼ç¾é‡è¤‡æ›¸ç±ï¼\nã€Œ${existingBook.title}ã€å·²å­˜åœ¨ã€‚\næ˜¯å¦è¦è‡ªå‹•å¡«å…¥æ›¸ç±è³‡æ–™ï¼Ÿ`,
                )
              ) {
                autoFillForm(existingBook);
              }
              lastAlertedTitle = normalizedInput;
            }, 400); // ä¿ç•™ä½ è¦æ±‚çš„ 400 æ¯«ç§’å»¶é²
          }
        } else {
          feedback.innerHTML = "âœ¨ æ›¸åº«å…§å°šæœªæœ‰æ­¤æ›¸";
          feedback.className = "search-feedback active status-new";
          lastAlertedTitle = "";
        }
      });

      // å°è£è‡ªå‹•å¡«å…¥é‚è¼¯
      function autoFillForm(book) {
        const titleField = document.getElementById("title");

        // 1. å¼·åˆ¶å¡«å…¥ä¸­æ–‡æ›¸å
        titleField.value = book.title || "";

        // 2. é‡è¦ï¼šç«‹åˆ»æ›´æ–°ã€Œæœ€å¾Œè­¦å‘Šéçš„æ›¸åã€ï¼Œé˜²æ­¢ input äº‹ä»¶å†æ¬¡è§¸ç™¼å°è‡´åˆ¤å®šé‡ç–Š
        lastAlertedTitle = normalizeText(book.title);

        document.getElementById("jpTitle").value = book.jpTitle || "";
        document.getElementById("author").value = book.author || "";
        document.getElementById("level").value = book.level || "æ­£å¸¸";
        document.getElementById("twStatus").value = book.twStatus || "";
        document.getElementById("jpStatus").value = book.jpStatus || "";
        document.getElementById("ebookUrl").value = book.ebookUrl || "";
        document.getElementById("chilUrl").value = book.chilUrl || "";
        document.getElementById("tags").value = book.tags || "";

        if (book.rating) {
          ratingInput.value = book.rating;
          updateRatingColor(book.rating);
        }

        if (book.coverUrl) {
          document.getElementById("coverUrl").value = book.coverUrl;
        }
        alert("âœ… è³‡æ–™å·²æˆåŠŸå¸¶å…¥ã€‚");
      }

      function clearFullForm() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰å¡«å¯«çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
          // ä¿®æ­£é€™è£¡ï¼šä½ çš„ form ID æ˜¯ bookForm
          const form = document.getElementById("bookForm");

          form.reset();

          // é¡å¤–é‡ç½®éš±è—æ¬„ä½èˆ‡æŒ‰éˆ•ç‹€æ…‹
          document.getElementById("coverUrl").value = "";
          document.getElementById("reviewer").value = "";

          // ç§»é™¤è©•è«–è€…æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
          document
            .querySelectorAll(".rev-btn")
            .forEach((b) => b.classList.remove("active"));

          form.reset();
          // å›å¾©é è¨­è©•åˆ†é¡è‰²
          updateRatingColor(5.0);

          console.log("è¡¨å–®å·²å®Œå…¨æ¸…ç©º");
        }
      }

      // æ–°å¢ï¼šå°ˆé–€ç”¨ä¾†éš±è—æœå°‹å›é¥‹èˆ‡é‡è¨­ç‹€æ…‹çš„å‡½å¼
      function resetSearchFeedback() {
        const feedback = document.getElementById("searchFeedback");
        if (feedback) {
          feedback.innerHTML = "";
          feedback.className = "search-feedback"; // ç§»é™¤ active é¡åˆ¥ä½¿å…¶éš±è—
        }
        lastAlertedTitle = ""; // æ¸…é™¤æœ€å¾Œæ¯”å°ç´€éŒ„ï¼Œè®“ä¸‹æ¬¡è¼¸å…¥åŒæ›¸åæ™‚èƒ½å†æ¬¡è§¸ç™¼æç¤º
      }

      let allTags = []; // å„²å­˜å¾ GAS æŠ“å›ä¾†çš„æ¨™ç±¤

      // å®šç¾©åˆ†é¡æ¨™ç±¤é›²
      const categorizedTags = {
        ä½œå“æ€§è³ª: ["æœ‰çºŒä½œ", "çºŒä½œ", "ç³»åˆ—ä½œ"],
        è§’è‰²èº«åˆ†: ["DK", "å¤§å­¸ç”Ÿ", "æ ¡åœ’æˆ€æ„›", "è·å ´", "åºŠä¼´", "éš±è—é¢è²Œ"],
        å…¶é¤˜ç‰¹è³ª: ["æš—æˆ€", "é›™å‘æš—æˆ€", "å¹´ä¸‹æ”»"],
      };
      const manualCloudTags = [
        "æœ‰çºŒä½œ",
        "çºŒä½œ",
        "ç³»åˆ—ä½œ",
        "æš—æˆ€",
        "é›™å‘æš—æˆ€",
        "éš±è—é¢è²Œ",
        "DK",
        "å¤§å­¸ç”Ÿ",
        "æ ¡åœ’æˆ€æ„›",
        "è·å ´",
        "åºŠä¼´",
      ];

      async function initTagFeatures() {
        try {
          const res = await fetch(`${scriptURL}?action=readTags`);
          allTags = await res.json();

          // æ¸²æŸ“æ¨™ç±¤é›²ï¼šç¾åœ¨æ”¹ç”¨ manualCloudTags
          renderTagCloud();
        } catch (e) {
          console.error("è¼‰å…¥æ¨™ç±¤å¤±æ•—", e);
          // å³ä½¿ GAS å¤±æ•—ï¼Œæ¨™ç±¤é›²é‚„æ˜¯å¯ä»¥æ¸²æŸ“è‡ªè¨‚æ¨™ç±¤
          renderTagCloud();
        }
      }

      // æ¸²æŸ“åˆ†é¡æ¨™ç±¤é›²
      function renderTagCloud() {
        const cloud = document.getElementById("tagCloud");
        if (!cloud) return;

        const categoryColors = {
          ä½œå“æ€§è³ª: "#74b9ff", // è—è‰²
          è§’è‰²èº«åˆ†: "#ff85a2", // æ©˜è‰²
          å…¶é¤˜ç‰¹è³ª: "#a29bfe", // ç¶ è‰²
        };

        let html = "";
        for (const [category, tags] of Object.entries(categorizedTags)) {
          const color = categoryColors[category] || "#95a5a6"; // è‹¥æ²’å°æ‡‰åˆ°å‰‡ç”¨ç°è‰²

          html += `
      <div class="tag-group">
        <div class="tag-group-title" style="border-left-color: ${color}">${category}</div>
        <div class="tag-group-items">
          ${tags
            .map(
              (tagName) => `
            <span class="cloud-item" 
                  style="border-left: 4px solid ${color} !important; background-color: ${color}15;" 
                  onclick="addTagFromUI('${tagName}')">
              + ${tagName}
            </span>
          `,
            )
            .join("")}
        </div>
      </div>
    `;
        }
        cloud.innerHTML = html;

        // æ‘ºç–ŠæŒ‰éˆ•é‚è¼¯ (ç¶­æŒåŸæœ¬çš„ JS)
        const toggleBtn = document.getElementById("toggleCloudBtn");
        toggleBtn.onclick = function () {
          const isExpanded = cloud.classList.toggle("expanded");
          this.innerText = isExpanded ? "æ”¶èµ·æ¨™ç±¤åˆ—è¡¨ â–²" : "å±•é–‹æ¨™ç±¤åˆ—è¡¨ â–¼";
        };
      }

      const tagInput = document.getElementById("tags");
      const customList = document.getElementById("customTagList");

      tagInput.addEventListener("input", function () {
        const fullVal = this.value;
        const parts = fullVal.split(/[ ,ã€]+/); // åˆ†å‰²ç¾æœ‰æ¨™ç±¤
        const currentQuery = parts[parts.length - 1].trim().toLowerCase();

        if (currentQuery === "") {
          customList.style.display = "none";
          return;
        }

        const matches = allTags.filter((t) =>
          t.name.toLowerCase().includes(currentQuery),
        );

        if (matches.length > 0) {
          customList.innerHTML = matches
            .map(
              (t) => `
      <div class="tag-item" onclick="addTagFromUI('${t.name}')">
        <strong>${t.name}</strong>
        <span class="tag-desc">${t.definition || ""}</span>
      </div>
    `,
            )
            .join("");
          customList.style.display = "block";
        } else {
          customList.style.display = "none";
        }
      });

      window.addTagFromUI = function (tagName) {
        const tagInput = document.getElementById("tags");
        let parts = tagInput.value.split(/[ ,ã€]+/);

        const existingTags = parts.map((p) => p.trim());
        if (!existingTags.includes(tagName)) {
          parts[parts.length - 1] = tagName;
          tagInput.value = parts.filter((p) => p !== "").join(", ") + ", ";
        }

        // é—œéµï¼šé¸å®Œæ¨™ç±¤å¾Œéš±è—æ¨è–¦æ¸…å–®ï¼Œè®“æ¨™ç±¤é›²é‡æ–°éœ²å‡ºä¾†
        document.getElementById("customTagList").style.display = "none";
        tagInput.focus();
      };

      // é»æ“Šå¤–éƒ¨é—œé–‰æœå°‹æ¨è–¦
      document.addEventListener("click", (e) => {
        if (e.target !== tagInput) customList.style.display = "none";
      });

      // ä¿®æ­£å¾Œçš„ addTagFromUI (é»æ“Šå¾Œè‡ªå‹•æ”¶èµ·æœå°‹æ¸…å–®)
      window.addTagFromUI = function (tagName) {
        const tagInput = document.getElementById("tags");
        let parts = tagInput.value.split(/[ ,ã€]+/);

        const existingTags = parts.map((p) => p.trim());
        if (!existingTags.includes(tagName)) {
          parts[parts.length - 1] = tagName;
          tagInput.value = parts.filter((p) => p !== "").join(", ") + ", ";
        }

        document.getElementById("customTagList").style.display = "none"; // é»é¸å¾Œç«‹åˆ»è“‹æ‰æ¨è–¦
        tagInput.focus();
      };

      window.addEventListener("load", initTagFeatures);
    </script>
  </body>
</html>
