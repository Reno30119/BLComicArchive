<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¨™ç±¤ç®¡ç† - æ¼«ç•«æ›¸åº«</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ·ï¸</text></svg>"
    />
    <style>
      .tag-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .tag-info {
        flex: 1;
      }
      .tag-name {
        font-weight: bold;
        color: #2c3e50;
      }
      .tag-def {
        font-size: 0.85rem;
        color: #7f8c8d;
      }
      .edit-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <nav class="top-nav">
      <a href="index.html" class="nav-item">â• æ–°å¢æ›¸ç±</a>
      <a href="list.html" class="nav-item">ğŸ” æŸ¥è©¢æ›¸åº«</a>
      <a href="tags.html" class="nav-item active">ğŸ·ï¸ æ¨™ç±¤ç®¡ç†</a>
    </nav>

    <div class="container">
      <h2>ğŸ·ï¸ æ¨™ç±¤å®šç¾©ç®¡ç†</h2>

      <div class="search-group" style="margin-top: 20px">
        <input
          type="text"
          id="tagSearchInput"
          placeholder="ğŸ” æœå°‹æ¨™ç±¤åç¨±æˆ–å®šç¾©..."
          style="
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-sizing: border-box;
          "
        />
        <!-- <p style="font-size: 0.8rem; color: #888; margin-top: 5px">
          * ç›®å‰å·²è‡ªå‹•æŒ‰ç­†ç•«é †åºç”±å°‘è‡³å¤šæ’åº
        </p> -->
      </div>

      <div
        class="form-group"
        style="
          margin-top: 20px;
          border: 1px solid #eee;
          padding: 15px;
          border-radius: 10px;
        "
      >
        <label id="formTitle">æ–°å¢æ¨™ç±¤å®šç¾©</label>
        <input type="text" id="tagName" placeholder="æ¨™ç±¤åç¨±" />
        <textarea
          id="tagDefinition"
          rows="2"
          placeholder="è¼¸å…¥æ¨™ç±¤å®šç¾©..."
          style="margin-top: 10px"
        ></textarea>

        <div style="display: flex; gap: 10px; margin-top: 10px">
          <button
            id="saveTagBtn"
            class="rev-btn active"
            style="flex: 2; margin-top: 0"
          >
            æ–°å¢æ¨™ç±¤
          </button>
          <button
            id="cancelEditBtn"
            class="rev-btn"
            style="
              flex: 1;
              margin-top: 0;
              background-color: #95a5a6;
              color: white;
              display: none;
            "
          >
            å–æ¶ˆç·¨è¼¯
          </button>
        </div>
      </div>

      <div id="tagList" style="margin-top: 20px">
        <p style="text-align: center">è¼‰å…¥æ¨™ç±¤ä¸­...</p>
      </div>
    </div>

    <script>
      // 1. å‹™å¿…å¡«å…¥èˆ‡ index.html ç›¸åŒçš„ scriptURL
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwqnfCjBq_BYZSWAOU6TnVj2O6YvFF2jan4dY0smm3waf9xP-wOLmz2_4B_L3MND7PK9A/exec";

      // è¼‰å…¥æ¨™ç±¤åˆ—è¡¨
      async function loadTags() {
        const listDiv = document.getElementById("tagList");
        try {
          // åŠ ä¸Š action=readTags åƒæ•¸
          const res = await fetch(`${scriptURL}?action=readTags`);
          const tags = await res.json();
          if (tags.length === 0) {
            listDiv.innerHTML =
              "<p style='text-align:center;'>ç›®å‰å°šç„¡æ¨™ç±¤å®šç¾©</p>";
            return;
          }
          listDiv.innerHTML = tags
            .map(
              (t) => `
            <div class="tag-list-item">
              <div class="tag-info">
                <div class="tag-name">${t.name}</div>
                <div class="tag-def">${t.definition || "æœªå®šç¾©"}</div>
              </div>
              <button class="edit-btn" onclick="editTag('${t.name}', '${t.definition}')">ç·¨è¼¯</button>
            </div>
          `,
            )
            .join("");
        } catch (err) {
          console.error(err);
          listDiv.innerHTML = "âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª GAS å·²ç™¼ä½ˆä¸¦é–‹å•Ÿæ¬Šé™ã€‚";
        }
      }

      function editTag(name, def) {
        document.getElementById("tagName").value = name;
        document.getElementById("tagDefinition").value = def;
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // å„²å­˜é‚è¼¯ä¿®æ­£
      document.getElementById("saveTagBtn").onclick = async function () {
        const name = document.getElementById("tagName").value.trim();
        const def = document.getElementById("tagDefinition").value.trim();
        if (!name) return alert("è«‹è¼¸å…¥æ¨™ç±¤åç¨±");

        this.disabled = true;
        this.innerText = "å„²å­˜ä¸­...";

        // ä½¿ç”¨ URLSearchParams ä¸¦æ˜ç¢ºåŠ å…¥ action åƒæ•¸
        const params = new URLSearchParams();
        params.append("action", "upsertTag");
        params.append("tagName", name);
        params.append("definition", def);

        try {
          // æ¨¡ä»¿ index.html çš„ç™¼é€æ–¹å¼ï¼Œè§£æ±º Failed to fetch å•é¡Œ
          await fetch(scriptURL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params.toString(),
          });

          alert(
            "âœ… å„²å­˜è«‹æ±‚å·²é€å‡ºï¼\n(ç”±æ–¼ Google æ¬Šé™æ©Ÿåˆ¶ï¼Œåˆ—è¡¨å°‡æ–¼ 2 ç§’å¾Œè‡ªå‹•æ›´æ–°)",
          );

          // æ¸…ç©ºè¼¸å…¥
          document.getElementById("tagName").value = "";
          document.getElementById("tagDefinition").value = "";

          // å»¶é²é‡æ•´ï¼Œçµ¦äºˆ GAS å¯«å…¥æ™‚é–“
          setTimeout(loadTags, 2000);
        } catch (err) {
          console.error(err);
          alert("å„²å­˜ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
        } finally {
          this.disabled = false;
          this.innerText = "å„²å­˜æ¨™ç±¤";
        }
      };

      // tags.html çš„ script å€å¡Š
      let allTags = []; // å„²å­˜æ‰€æœ‰æ¨™ç±¤è³‡æ–™

      async function loadTags() {
        const listDiv = document.getElementById("tagList");
        try {
          const res = await fetch(`${scriptURL}?action=readTags`);
          allTags = await res.json();

          // 1. å¯¦ä½œæŒ‰ç­†ç•«æ’åº (ä½¿ç”¨ zh-Hant å€åŸŸåŒ–æ¯”å°)
          allTags.sort((a, b) => a.name.localeCompare(b.name, "zh-Hant"));

          renderTagList(allTags); // åˆå§‹æ¸²æŸ“å…¨éƒ¨æ¨™ç±¤
        } catch (err) {
          console.error(err);
          listDiv.innerHTML = "âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª GAS å·²ç™¼ä½ˆã€‚";
        }
      }

      // 2. å°è£æ¸²æŸ“é‚è¼¯ï¼Œæ–¹ä¾¿æœå°‹æ™‚é‡è¤‡å‘¼å«
      function renderTagList(data) {
        const listDiv = document.getElementById("tagList");
        if (data.length === 0) {
          listDiv.innerHTML =
            "<p style='text-align:center;'>æ‰¾ä¸åˆ°ç¬¦åˆçš„æ¨™ç±¤</p>";
          return;
        }

        listDiv.innerHTML = data
          .map(
            (t) => `
    <div class="tag-list-item">
      <div class="tag-info">
        <div class="tag-name">${t.name}</div>
        <div class="tag-def">${t.definition || "æœªå®šç¾©"}</div>
      </div>
      <button class="edit-btn" onclick="editTag('${t.name}', '${t.definition}')">ç·¨è¼¯</button>
    </div>
  `,
          )
          .join("");
      }

      // 3. ç›£è½æœå°‹è¼¸å…¥äº‹ä»¶
      document
        .getElementById("tagSearchInput")
        .addEventListener("input", function () {
          const term = this.value.toLowerCase().trim();

          // éæ¿¾æ¨™ç±¤åç¨±æˆ–å®šç¾©å…§å®¹
          const filtered = allTags.filter(
            (t) =>
              t.name.toLowerCase().includes(term) ||
              (t.definition && t.definition.toLowerCase().includes(term)),
          );

          renderTagList(filtered);
        });

      // tags.html çš„ script å€å¡Š

      // å°è£ä¸€å€‹æ¸…ç©ºè¡¨å–®çš„å‡½å¼
      function resetTagForm() {
        document.getElementById("tagName").value = "";
        document.getElementById("tagDefinition").value = "";
        // å¦‚æœä½ æœ‰å¯¦ä½œã€Œæœå°‹å¾Œç·¨è¼¯ã€ï¼Œä¹Ÿå¯ä»¥åœ¨é€™è£¡æ±ºå®šæ˜¯å¦æ¸…ç©ºæœå°‹æ¡†
      }

      // ç¶å®šå–æ¶ˆæŒ‰éˆ•é»æ“Šäº‹ä»¶
      document.getElementById("cancelEditBtn").onclick = function () {
        resetTagForm();
      };

      // ä¿®æ”¹åŸæœ¬çš„å„²å­˜é‚è¼¯
      document.getElementById("saveTagBtn").onclick = async function () {
        const name = document.getElementById("tagName").value.trim();
        const def = document.getElementById("tagDefinition").value.trim();
        if (!name) return alert("è«‹è¼¸å…¥æ¨™ç±¤åç¨±");

        this.disabled = true;
        this.innerText = "å„²å­˜ä¸­...";

        const params = new URLSearchParams();
        params.append("action", "upsertTag");
        params.append("tagName", name);
        params.append("definition", def);

        try {
          await fetch(scriptURL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params.toString(),
          });

          alert(
            "âœ… å„²å­˜è«‹æ±‚å·²é€å‡ºï¼\n(ç”±æ–¼ Google æ¬Šé™æ©Ÿåˆ¶ï¼Œåˆ—è¡¨å°‡æ–¼ 2 ç§’å¾Œè‡ªå‹•æ›´æ–°)",
          );

          // ä½¿ç”¨å‰›å°è£å¥½çš„æ¸…ç©ºå‡½å¼
          resetTagForm();

          setTimeout(loadTags, 2000);
        } catch (err) {
          console.error(err);
          alert("å„²å­˜ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
        } finally {
          this.disabled = false;
          this.innerText = "å„²å­˜æ¨™ç±¤";
        }
      };

      // 1. å¡«å…¥ç·¨è¼¯æ¡† (é»æ“Šåˆ—è¡¨çš„ç·¨è¼¯æŒ‰éˆ•æ™‚)
      function editTag(name, def) {
        document.getElementById("tagName").value = name;
        document.getElementById("tagDefinition").value = def;

        // è®Šæ›´ä»‹é¢æ–‡å­—
        document.getElementById("saveTagBtn").innerText = "æ›´æ–°æ¨™ç±¤";
        document.getElementById("formTitle").innerText = "ç·¨è¼¯æ¨™ç±¤å®šç¾©";
        document.getElementById("cancelEditBtn").style.display = "block"; // é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // 2. é‡ç½®è¡¨å–® (å›åˆ°åˆå§‹ç‹€æ…‹)
      function resetTagForm() {
        document.getElementById("tagName").value = "";
        document.getElementById("tagDefinition").value = "";

        // æ¢å¾©ä»‹é¢æ–‡å­—
        document.getElementById("saveTagBtn").innerText = "æ–°å¢æ¨™ç±¤";
        document.getElementById("formTitle").innerText = "æ–°å¢æ¨™ç±¤å®šç¾©";
        document.getElementById("cancelEditBtn").style.display = "none"; // éš±è—å–æ¶ˆæŒ‰éˆ•
      }

      // 3. ç¶å®šå–æ¶ˆæŒ‰éˆ•
      document.getElementById("cancelEditBtn").onclick = function () {
        resetTagForm();
      };

      // 4. ä¿®æ”¹å„²å­˜å¾Œçš„é‚è¼¯
      document.getElementById("saveTagBtn").onclick = async function () {
        const name = document.getElementById("tagName").value.trim();
        const def = document.getElementById("tagDefinition").value.trim();
        if (!name) return alert("è«‹è¼¸å…¥æ¨™ç±¤åç¨±");

        const originalText = this.innerText; // ç´€éŒ„ç›®å‰çš„æŒ‰éˆ•æ–‡å­— (æ–°å¢æˆ–æ›´æ–°)
        this.disabled = true;
        this.innerText = "è™•ç†ä¸­...";

        const params = new URLSearchParams();
        params.append("action", "upsertTag");
        params.append("tagName", name);
        params.append("definition", def);

        try {
          await fetch(scriptURL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params.toString(),
          });

          alert("âœ… è«‹æ±‚å·²é€å‡ºï¼æ¸…å–®å°‡æ–¼ 2 ç§’å¾Œè‡ªå‹•æ›´æ–°");
          resetTagForm(); // å„²å­˜æˆåŠŸå¾Œåˆ‡æ›å›ã€Œæ–°å¢ã€æ¨¡å¼
          setTimeout(loadTags, 2000);
        } catch (err) {
          alert("å„²å­˜ç™¼ç”ŸéŒ¯èª¤");
          this.innerText = originalText;
        } finally {
          this.disabled = false;
        }
      };

      loadTags();
    </script>
  </body>
</html>
